<!DOCTYPE html>

<html lang="zh-Hant">
<head>
<link href="styles.css" rel="stylesheet"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>自然大叔 ∣ 訂單排程系統</title>
<link href="https://res.cloudinary.com/dijzndzw2/image/upload/v1757176751/logo-3_hddq08.png" rel="icon" type="image/png"/>
<script defer="True" src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<header>
<div class="wrap toolbar">
<div class="pill">
<strong>月份</strong>
<select id="yearSel"><option value="自然大叔"></option></select>
<select id="monthSel"></select>
</div>
<div class="pill">
<strong>作業人員</strong>
<select id="staffFilter"></select>
</div>
<div class="pill">
<strong>狀況</strong>
<select id="statusFilter">
<option value="">全部</option>
<option value="排定">排定</option>
<option value="完成">完成</option>
<option value="未完成">未完成</option>
</select>
</div>
<div class="pill">
<strong>完成時間</strong>
<select id="completedRange">
<option value="">全部</option>
<option value="7">近7天</option>
<option value="30">近30天</option>
</select>
</div>
<label class="pill" style="gap:8px">
<input checked="" id="showUndated" type="checkbox"/>
<span>顯示未排期</span>
</label>
<div class="pill">
<strong>搜尋</strong>
<input id="searchInput" placeholder="姓名 / 電話 / 地址" style="width:220px" type="text"/>
</div>
<div class="right"><button class="accent" id="gdriveBackupBtn" onclick="initGoogleBackup()">☁️Google</button>
<button class="accent" id="newBtn">新增訂單</button>
<button id="newExpenseBtn">新增花費</button>
<button id="exportJson">匯出JSON</button>
<button id="exportXlsx">匯出Excel</button>
<button class="warn" id="importJson">匯入JSON</button>
<button class="danger" id="clearAll">清空資料</button></div>
</div>
</header>
<main class="wrap stack" style="margin-top:16px">
<!-- 訂單列表（上） -->
<section class="card">
<h2>訂單列表</h2>
<div class="body">
<div class="sum" id="summary"></div>
<div class="hr"></div>
<div class="small muted"><details class="yearly-stats" id="ys-accordion"><summary class="ys-summary"><span aria-hidden="true" class="ys-chevron">▸</span><span class="ys-title">查看年度資料</span></summary><div class="ys-content"><h2>查看年度資料</h2><div class="ys-controls"><label>年份：<select id="yearSelect"></select></label><button id="recalc">計算</button></div><div class="ys-cards"><div class="ys-card"><div class="ys-card-title">年度訂單數</div><div class="ys-card-value" id="mOrders">--</div></div><div class="ys-card"><div class="ys-card-title">年度總金額</div><div class="ys-card-value" id="mGross">--</div></div><div class="ys-card"><div class="ys-card-title">年度折後總金額</div><div class="ys-card-value" id="mDiscounted">--</div></div><div class="ys-card"><div class="ys-card-title">年度花費</div><div class="ys-card-value" id="mCost">--</div></div><div class="ys-card"><div class="ys-card-title">年度淨收入</div><div class="ys-card-value" id="mNet">--</div></div></div><details><summary>如何提供資料？</summary><p>在任一 script 中賦值 window.orders = [...]：每筆需含 date(YYYY-MM-DD)、amount(原價)、discounted(折後價，可無則視為 amount)、cost(成本/花費，可無則視為 0)。</p><pre>window.orders = [
  { date: "2025-01-05", amount: 1200, discounted: 1100, cost: 400 },
  { date: "2025-03-22", amount: 900, discounted: 900, cost: 200 },
];</pre></details><style>
/* Accordion Summary */
.yearly-stats { border: 1px solid #eee; border-radius: 12px; overflow: clip; }
.yearly-stats > .ys-summary {
  display:flex; align-items:center; gap:8px; padding:10px 12px;
  font-weight:600; cursor:pointer; user-select:none;
  background: linear-gradient(180deg, #fafafa, #f3f3f3);
}
.yearly-stats[open] > .ys-summary { background: #f9fafb; border-bottom:1px solid #eee; }
.ys-chevron { display:inline-block; transition: transform .2s ease; }
.yearly-stats[open] > .ys-summary .ys-chevron { transform: rotate(90deg); }
.ys-content { padding: 12px; }

/* Controls & Cards */
.ys-controls { display:flex; align-items:center; gap: 12px; margin: 8px 0 16px; flex-wrap: wrap; }
.ys-cards { display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap: 12px; }
.ys-card { padding: 12px; border: 1px solid #eee; border-radius: 12px; background:#fff; }
.ys-card-title { font-size: 12px; opacity: 0.7; }
.ys-card-value { font-size: 20px; font-weight: 700; }

/* Pretty button */
#recalc {
  appearance: none;
  padding: 8px 14px;
  border-radius: 9999px;
  border: 1px solid rgba(0,0,0,.08);
  background: linear-gradient(180deg, #4f8cff, #2f6bff);
  color: #fff;
  font-weight: 600;
  box-shadow: 0 6px 16px rgba(47,107,255,.25), 0 1px 0 rgba(255,255,255,.2) inset;
  transition: transform .06s ease, box-shadow .2s ease, filter .2s ease;
}
#recalc:hover { filter: brightness(1.05); box-shadow: 0 8px 20px rgba(47,107,255,.3), 0 1px 0 rgba(255,255,255,.25) inset; }
#recalc:active { transform: translateY(1px); }
#recalc:focus { outline: 2px solid #8ab4ff; outline-offset: 2px; }

/* Reduce motion */
@media (prefers-reduced-motion: reduce) {
  .ys-chevron { transition: none; }
  #recalc { transition: none; }
}

#yearSelect {
  font-size: 16px;
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background: #fff;
  font-weight: 600;
  color: #333;
}
</style><script>
(function(){
  function currency(n){ if(isNaN(n)) return "--"; return n.toLocaleString(undefined,{minimumFractionDigits:0}); }
  function getYears(orders){
    const set = new Set();
    orders.forEach(o=>{
      const y = (o.date||"").slice(0,4);
      if(/^[0-9]{4}$/.test(y)) set.add(y);
    });
    if(set.size===0){ set.add(String(new Date().getFullYear())); }
    return Array.from(set).sort();
  }
  function calc(year){
    const orders = (window.orders||[]).filter(o=> (o.date||"").startsWith(String(year)));
    const count = orders.length;
    let gross=0, discounted=0, cost=0;
    orders.forEach(o=>{
      const a = Number(o.amount)||0;
      const d = (o.discounted==null? a : Number(o.discounted)||0);
      const c = Number(o.cost)||0;
      gross += a; discounted += d; cost += c;
    });
    const net = discounted - cost;
    document.getElementById('mOrders').textContent = currency(count);
    document.getElementById('mGross').textContent = currency(gross);
    document.getElementById('mDiscounted').textContent = currency(discounted);
    document.getElementById('mCost').textContent = currency(cost);
    document.getElementById('mNet').textContent = currency(net);
  }
  function init(){
    const orders = (window.orders||[]);
    const years = getYears(orders);
    const sel = document.getElementById('yearSelect');
    sel.innerHTML = "";
    years.forEach(y=>{
      const opt = document.createElement('option');
      opt.value = y; opt.textContent = y;
      sel.appendChild(opt);
    });
    const nowY = String(new Date().getFullYear());
    if(years.includes(nowY)) sel.value = nowY;
    calc(sel.value);
    document.getElementById('recalc').addEventListener('click', ()=> calc(sel.value));
    sel.addEventListener('change', ()=> calc(sel.value));
    // Recalculate if someone updates window.orders later
    const iv = setInterval(()=>{
      if(window.__orders_len !== (window.orders||[]).length){
        window.__orders_len = (window.orders||[]).length;
        // Rebuild years & recalc
        const ys = getYears(window.orders||[]);
        const same = ys.length===sel.options.length && Array.from(sel.options).every((o,i)=>o.value===ys[i]);
        if(!same){
          sel.innerHTML=""; ys.forEach(y=>{ const opt=document.createElement('option'); opt.value=y; opt.textContent=y; sel.appendChild(opt); });
        }
        if(sel.value && ys.includes(sel.value)) calc(sel.value); else { sel.value = ys[ys.length-1]; calc(sel.value); }
      }
    }, 1500);
  }
  if(document.readyState!=='loading') init(); else document.addEventListener('DOMContentLoaded', init);
})();
</script></div></details></div>
<div style="overflow:auto;margin-top:8px">
<!-- 快到期提醒區塊 -->
<div class="card due-panel" id="dueSoonPanel">
<div class="card-title">快到期提醒（30 天內）</div>
<div class="due-list empty" id="dueSoonList">目前沒有 30 天內將到期的客戶</div>
</div>
<table id="ordersTable">
<thead>
<tr>
<th>#</th>
<th>日期</th>
<th>時間</th>
<th>作業人員</th>
<th>客戶</th>
<th>電話</th>
<th class="col-slot">時段</th>
<th>地址</th>
<th class="col-status">狀況</th>
<th>確認</th>
<th>報價單</th>
<th class="right-align col-total">總金額</th>
<th class="right-align">折後</th>
<th>來源</th>
<th>操作</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
</section>
<!-- 訂單表單（中） -->
<details class="accordion" id="orderAccordion"><summary><span id="formTitle">新增 / 編輯訂單</span></summary><div class="content">
<form id="orderForm">
<input id="id" type="hidden"/>
<div class="row">
<div class="col" style="grid-column:span 6">
<label>作業人員</label>
<div class="toolbar" style="gap:8px">
<select id="staff"><option value="透天屋"></option><option value="大樓(有電梯)"></option><option value="大樓(無電梯)"></option><option value="其他(可自行輸入)"></option></select>
<button class="inline-btn" id="addStaffBtn" type="button">新增人員</button>
</div>
</div>
<div class="col" style="grid-column:span 3">
<label>日期（可留空，之後再填）</label>
<input id="date" type="date"/>
</div>
<div class="col" style="grid-column:span 3">
<label>時間</label>
<input id="time" type="time"/>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 6">
<label>姓名（支援通訊錄）</label>
<input id="customer" list="contactsDL" placeholder="客戶姓名" type="text"/>
<datalist id="contactsDL"></datalist>
<div class="tiny">選既有客戶會自動帶出電話/地址</div>
</div>
<div class="col" style="grid-column:span 3">
<label>LINE or Fackbook ID</label>
<input id="lineId" type="text"/>
</div>
<div class="col" style="grid-column:span 3">
<label>電話</label>
<input id="phone" placeholder="手機（可留空）0912-345-678；或改填 LINE" type="text"/>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 5">
<label>安排時段（可複選）</label>
<div class="checkbox-group" id="slotGroup"></div>
<input class="hidden tiny" id="slotNote" placeholder="請輸入指定日期／時段（如 10/10 上午 或 10/12 9:00–12:00）" type="text"/>
</div>
<div class="col" style="grid-column:span 7">
<label>清洗地址</label>
<input id="address" placeholder="地址" type="text"/>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 6">
<label>居住地型態</label>
<div class="toolbar" style="gap:8px">
<select id="residenceType">
<option value="">（未選擇）</option>
<option value="透天屋">透天屋</option>
<option value="大樓(有電梯)">大樓(有電梯)</option>
<option value="大樓(無電梯)">大樓(無電梯)</option>
<option value="其他">其他（可自行輸入）</option>
</select>
<input class="hidden" id="residenceOther" placeholder="請輸入其他型態" type="text"/>
</div>
</div>
<div class="col" style="grid-column:span 6">
<label>方便聯繫時間（可複選）</label>
<div class="checkbox-group" id="contactTimesGroup"></div>
<input class="hidden tiny" id="contactTimeNote" placeholder="請輸入指定時間（如 9:00–12:00 或 週三晚上）" type="text"/>
</div>
</div>
<div class="row" id="reminderRow">
<div class="col" style="grid-column:span 6">
<div class="toolbar" id="reminderToolbar" style="gap:8px; align-items:center; flex-wrap:wrap">
<label class="pill"><input checked="" id="reminderEnabled" type="checkbox"/> <span>啟用提醒</span></label>
<label class="muted">提醒週期（月）</label>
<input class="tiny compact" id="reminderMonths" min="0" placeholder="例如 12" step="1" type="number" value="24"/>
<label class="muted">下次提醒</label>
<input class="tiny" disabled="" id="nextReminder" type="text"/>
<label class="pill"><input id="reminderNotified" type="checkbox"/> <span>已通知</span></label>
<label class="pill danger"><input id="reminderMuted" type="checkbox"/> <span>不再提醒</span></label>
</div>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 6">
<label>冷氣位於樓層（可複選）</label>
<div class="checkbox-group" id="acFloors"></div>
<div class="hidden" id="acFloorAboveWrap"><input id="acFloorAbove" placeholder="請輸入實際樓層（例：6F、7F…）" type="text"/></div>
</div>
<div class="col" style="grid-column:span 6">
<label>洗衣機位於樓層（可複選）</label>
<div class="checkbox-group" id="washerFloors"></div>
<div class="hidden" id="washerFloorAboveWrap"><input id="washerFloorAbove" placeholder="請輸入實際樓層（例：6F、7F…）" type="text"/></div>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 8">
<label>與我司聯繫方式</label>
<div class="toolbar" style="gap:8px">
<select id="contactMethod"></select>
<button class="inline-btn" id="addContactMethod" type="button">新增聯繫方式</button>
</div>
</div>
<div class="col" style="grid-column:span 4">
<label>狀況</label>
<select id="status">
<option value="排定">排定</option>
<option value="完成">完成</option>
<option value="未完成">未完成</option>
</select>
</div>
</div>
<div class="hr"></div>
<h3 style="margin:0 0 8px">清洗項目與價格</h3>
<div class="row">
<div class="col" style="grid-column:span 6">
<label><b><span style="color:red;font-size:15px">分離式冷氣室內機（每台1800；滿3台每台1500）</span></b></label>
<input id="acSplit" min="0" step="1" type="number" value="0"/>
</div>
<div class="col" style="grid-column:span 6">
<label>吊隱式冷氣（每台2800）</label>
<input id="acDuct" min="0" step="1" type="number" value="0"/>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 6">
<label><b><span style="color:red;font-size:15px">直立式洗衣機（每台2000；若同單含冷氣室內機則每台1800）</span></b></label>
<input id="washerTop" min="0" step="1" type="number" value="0"/>
</div>
<div class="col" style="grid-column:span 6">
<label>水塔（每顆1000）</label>
<input id="waterTank" min="0" step="1" type="number" value="0"/>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 6">
<label>自來水管（自訂金額，未稅總額）</label>
<input id="pipesAmount" min="0" step="1" type="number" value="0"/>
</div>
<div class="col" style="grid-column:span 6">
<label><b><span style="color:red;font-size:15px">防霉噴劑（每台300；滿5台每台250）</span></b></label>
<input id="antiMold" min="0" step="1" type="number" value="0"/>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 6">
<label>臭氧殺菌（每間200）</label>
<input id="ozone" min="0" step="1" type="number" value="0"/>
</div>
<div class="col" style="grid-column:span 6">
<label>變形金剛機型（每台加500）</label>
<input id="transformerCount" min="0" step="1" type="number" value="0"/>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 6">
<label>分離式室內機長度 &gt; 182cm（每台加300）</label>
<input id="longSplitCount" min="0" step="1" type="number" value="0"/>
</div>
<div class="col" style="grid-column:span 6">
<label>一體式水盤（每台加500）</label>
<input id="onePieceTray" min="0" step="1" type="number" value="0"/>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 12">
<label>備註</label>
<textarea id="note" placeholder="其他補充事項"></textarea>
</div>
</div>
<div class="hr"></div>
<div class="row">
<div class="col" style="grid-column:span 4">
<label><input id="confirmed" type="checkbox"/> 客人確認安排時間</label>
</div>
<div class="col" style="grid-column:span 4">
<label><input id="quotationOk" type="checkbox"/> 客人確認報價單</label>
</div>
<div class="col right-align" style="grid-column:span 4">
<button class="inline-btn" id="recalc" type="button">重新計算金額</button>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 3">
<label>總金額（自動）</label>
<input id="total" readonly="" type="number"/>
</div>
<div class="col" style="grid-column:span 3">
<label>額外加價（手動輸入）</label>
<input id="extraCharge" min="0" step="1" type="number" value="0"/>
</div>
<div class="col" style="grid-column:span 3">
<label>折扣金額（可輸入）</label>
<input id="discount" min="0" step="1" type="number" value="0"/>
</div>
<div class="col" style="grid-column:span 3">
<label>折後總金額（自動）</label>
<input id="netTotal" readonly="" type="number"/>
</div>
</div>
<div class="hr"></div>
<div class="toolbar">
<button class="primary" id="saveBtn" type="submit">儲存訂單</button>
<button id="resetBtn" type="button">清空表單</button>
<button id="copyLastBtn" type="button">複製上一筆</button>
<button id="copyFromHistoryBtn" type="button">從客戶舊單帶入</button>
<div class="right">
<span class="lock-badge" id="lockInfo"></span>
<div style="display:inline-block; margin-right:8px;"><label style="margin-right:4px;">時長(分)</label><input id="durationMinutes" min="15" step="15" style="width:70px;" type="number" value="120"/></div><button class="btn" onclick="handleUploadWithAuth(gatherForm())">📅</button><button class="warn" id="toggleLock" type="button">解鎖金額編輯</button>
<button class="danger" disabled="" id="deleteBtn" type="button">刪除此訂單</button>
</div>
</div>
</form>
</div></details>
<!-- 支出模組（下）以手風琴呈現 -->
<details =""="" class="accordion" id="expenseAcc">
<summary>本月花費（可展開/收合）</summary>
<div class="content">
<div class="two-col">
<section class="card" style="border:none;box-shadow:none">
<h2>本月花費列表</h2>
<div class="body">
<div class="toolbar" style="margin-bottom:8px">
<button id="expExportCsv">匯出花費CSV</button>
<button id="expExportJson">匯出花費JSON</button>
<button class="warn" id="expImportJson">匯入花費JSON</button>
<button class="danger" id="expClear">清空花費</button>
</div>
<div style="overflow:auto">
<table id="expenseTable">
<thead>
<tr>
<th>#</th>
<th>日期</th>
<th>類別</th>
<th>說明</th>
<th class="right-align">金額</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
</section>
<aside class="card" style="border:none;box-shadow:none">
<h2>新增 / 編輯花費</h2>
<div class="body">
<form id="expenseForm">
<input id="expId" type="hidden"/>
<div class="row">
<div class="col" style="grid-column:span 4">
<label>日期</label>
<input id="expDate" type="date"/>
</div><div class="col" style="grid-column:span 3"><label>工作時長（分鐘）</label><input id="durationMinutes" min="15" step="15" type="number" value="120"/></div>
<div class="col" style="grid-column:span 4">
<label>類別</label>
<div class="toolbar" style="gap:8px">
<select id="expCategory"></select>
<button class="inline-btn" id="addExpCat" type="button">新增類別</button>
</div>
</div>
<div class="col" style="grid-column:span 4">
<label>金額</label>
<input id="expAmount" min="0" step="1" type="number" value="0"/>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 12">
<label>說明</label>
<input id="expNote" placeholder="例如：材料、加油、停車、工具維修…" type="text"/>
</div>
</div>
<div class="toolbar">
<button class="primary" id="expSave" type="submit">儲存花費</button>
<button id="expReset" type="button">清空表單</button>
<div class="right">
<button class="danger" disabled="" id="expDelete" type="button">刪除此筆花費</button>
</div>
</div>
</form>
</div>
</aside>
</div>
</div>
</details>
</main>
<input accept=".json" class="hidden" id="filePicker" type="file"/>
<input accept=".json" class="hidden" id="filePickerExp" type="file"/>
<template id="expRowTpl">
<tr>
<td class="small muted"></td>
<td></td><td></td><td></td><td class="right-align"></td>
</tr>
</template>
<script src="https://apis.google.com/js/api.js"></script>
<div>
<!-- ✅ 載入 Google OAuth SDK -->
<script async="" defer="" src="https://accounts.google.com/gsi/client"></script>
<!-- ✅ 加在 refreshTable 的每筆訂單操作欄位中 -->
<!-- ✅ 表單中新增：工作時長欄位 -->
<!-- ✅ gatherForm() 中補上 -->
</div>
<script defer="" src="app.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  var acc = document.getElementById('ys-accordion');
  var btn = document.getElementById('recalc');
  if (!acc || !btn) return;
  acc.addEventListener('toggle', function(){
    if (acc.open) { btn.click(); }
  });
});
</script></body>
</html>
<!-- 加入 Google API SDK -->
<script async="" defer="" src="https://accounts.google.com/gsi/client"></script>
