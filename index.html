<!DOCTYPE html>

<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>è‡ªç„¶å¤§å” âˆ£ è¨‚å–®æ’ç¨‹ç³»çµ±</title>
<link href="https://res.cloudinary.com/dijzndzw2/image/upload/v1757176751/logo-3_hddq08.png" rel="icon" type="image/png"/>
<style>
    

:root {
  --bg: #e0e7ef;
  --card: #ffffff;
  --muted: #374151;
  --text: #111827;
  --primary: #2563eb;
  --primary-weak: #bfdbfe;
  --accent: #059669;
  --warn: #d97706;
  --danger: #dc2626;
  --border: #94a3b8;
  --radius: 16px;
  --shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
}


    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui, -apple-system, "Noto Sans TC", Segoe UI, Roboto, Helvetica, Arial;
      background:linear-gradient(180deg,var(--bg),#eef2ff);
      color:var(--text);
    }
    header{
      position:sticky;top:0;z-index:10;
      background:rgba(255,255,255,.8);backdrop-filter:saturate(1.2) blur(8px);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .stack{display:flex;flex-direction:column;gap:16px}
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);
    }
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--border);font-size:18px}
    .card .body{padding:16px}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-bottom:12px}
    @media (max-width:900px){.row{grid-template-columns:repeat(6,1fr)}}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea,button{font:inherit}
    input[type="text"],input[type="date"],input[type="time"],input[type="number"],select,textarea{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;outline:none;
    }
    textarea{min-height:72px;resize:vertical}
    .muted{color:var(--muted)}
    .pill{
      border-radius:999px;padding:8px 12px;border:1px solid var(--border);background:#fff;display:inline-flex;gap:8px;align-items:center
    }
    .toolbar{display:flex;flex-wrap:wrap;gap:8px}
    .toolbar button, .toolbar .right button{
      padding:10px 14px;border-radius:999px;border:1px solid var(--border);
      background:#fff;color:var(--text);cursor:pointer
    }
    .toolbar .primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .toolbar .accent{background:var(--accent);color:#fff;border-color:var(--accent)}
    .toolbar .warn{background:var(--warn);color:#111}
    .toolbar .danger{background:var(--danger);color:#fff}
    .toolbar .right{margin-left:auto;display:flex;gap:8px}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:12px;border:1px solid var(--border)}
    thead th{background:#f3f4f6;color:#374151;font-weight:600;text-align:left;font-size:12px;padding:10px;border-bottom:1px solid var(--border)}
    tbody td{padding:10px;border-bottom:1px solid var(--border);vertical-align:top}
    tbody tr:hover{background:#fafafa}
    .status{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid;cursor:pointer;user-select:none}
    .status.Pæ’å®š{color:#2563eb;border-color:#93c5fd;background:#eff6ff}
    .status.Cå®Œæˆ{color:#10b981;border-color:#a7f3d0;background:#ecfdf5}
    .status.Næœªå®Œæˆ{color:#ef4444;border-color:#fecaca;background:#fef2f2}
    .sum{display:flex;gap:12px;flex-wrap:wrap}
    .sum .box{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px 14px;min-width:170px;box-shadow:var(--shadow)}
    .number{font-size:18px;font-weight:700}
    .small{font-size:12px}
    .hr{height:1px;background:var(--border);margin:8px 0 16px}
    .inline-btn{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;color:var(--text);cursor:pointer;margin-left:8px}
    .right-align{text-align:right}
    .editable{cursor:pointer}
    .editable:hover{background:#f9fafb}
    .checkpill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;cursor:pointer;user-select:none}
    .checkpill.on{background:#ecfdf5;border-color:#a7f3d0;color:#059669}
    .checkpill.off{background:#f9fafb;color:#6b7280}
    .icon-btn{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .icon-btn.danger{background:#fee2e2;border-color:#fecaca;color:#b91c1c}
    .hidden{display:none !important}
    .checkbox-group{display:flex;gap:8px;flex-wrap:wrap}
    .checkbox{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#fff}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.two-col{grid-template-columns:1fr}}
    mark{background:#fde68a;padding:0 .15em;border-radius:3px}
    .badge-soft{display:inline-block;padding:2px 8px;border-radius:999px;background:#f3f4f6;color:#374151;font-size:12px}
    .lock-badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#6b7280}
    .tiny{font-size:11px;color:#6b7280}
    /* Accordion */
    details.accordion{border:1px solid var(--border);border-radius:var(--radius);background:var(--card);box-shadow:var(--shadow)}
    details.accordion > summary{list-style:none;cursor:pointer;padding:14px 16px;border-radius:var(--radius);font-weight:600}
    details.accordion[open] > summary{border-bottom:1px solid var(--border)}
    details.accordion .content{padding:16px}
  
/* å¢å¼·æŒ‰éˆ•è¦–è¦º */
button, .toolbar button {
  transition: background 0.2s ease, color 0.2s ease;
}
button:hover, .toolbar button:hover {
  filter: brightness(1.1);
}

/* ä¸»è¦æŒ‰éˆ•å¼·åŒ– */
.toolbar .primary {
  background: var(--primary);
  color: #fff;
  border-color: var(--primary);
}
.toolbar .primary:hover {
  background: #1e40af;
}

/* å¼·èª¿æŒ‰éˆ•ï¼ˆå¦‚ Google/æ–°å¢ï¼‰ */
.toolbar .accent {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}
.toolbar .accent:hover {
  background: #047857;
}

/* å±éšªæŒ‰éˆ• hover å¼·åŒ– */
.toolbar .danger:hover {
  background: #b91c1c;
}

/* æ¸…æ™°çš„ç‹€æ…‹åœ“è§’æ¨™ç±¤ */
.status {
  font-weight: bold;
  border-width: 2px;
}

/* è¡¨æ ¼è¡Œ hover é«˜äº® */
tbody tr:hover {
  background: #f0f9ff;
}

/* æœå°‹é«˜äº® mark é¡è‰²åŠ æ·± */
mark {
  background: #facc15;
  color: #000;
}

/* å¼·åŒ–è¼¸å…¥æ¬„ä½èˆ‡å¡ç‰‡å°æ¯” */
input[type="text"],
input[type="date"],
input[type="time"],
input[type="number"],
select,
textarea {
  background: #f9fafb;
  border: 1px solid var(--border);
  color: var(--text);
}

.card {
  background: var(--card);
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
}

/* hover ç‹€æ…‹åŠ å¼· */
button:hover,
.toolbar button:hover {
  filter: brightness(1.12);
}

/* è¡¨æ ¼ hover æ›´æ˜é¡¯ */
tbody tr:hover {
  background: #dbeafe;
}

/* å¼·åŒ–è¡¨æ ¼æ¨™é ­å°æ¯” */
thead th {
  background: #e2e8f0;
  color: #1e293b;
}

/* æœå°‹ mark å¼·åŒ– */
mark {
  background: #facc15;
  padding: 0 0.2em;
  border-radius: 2px;
}

/* === Mobile Enhancements === */
@media (max-width: 768px) {
  .wrap { padding: 12px; }
  .toolbar { flex-direction: column; align-items: stretch; gap: 10px; }
  .toolbar .right { margin-left: 0; width: 100%; display: flex; flex-direction: column; gap: 8px; }
  .toolbar button, .toolbar .right button { width: 100%; min-height: 44px; font-size: 16px; }
  .pill { width: 100%; }
  .pill input, .pill select { width: 100% !important; }
  .row { grid-template-columns: 1fr !important; }
  .two-col { grid-template-columns: 1fr !important; }
}

@media (max-width: 600px) {
  /* Turn the big table into stacked cards */
  table { border: 0; }
  table thead { display: none; }
  table tr { display: block; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 12px; padding: 8px; box-shadow: var(--shadow); }
  table td { display: block; border: none; padding: 8px; text-align: left; }
  table td.right-align { text-align: left; }
  table td::before {
    content: attr(data-label);
    font-weight: 600;
    display: block;
    margin-bottom: 4px;
    color: var(--muted);
    font-size: 12px;
  }
  /* Make pills/buttons comfortable to tap */
  button, .toolbar button { min-height: 44px; }
  input, select, textarea { font-size: 16px; } /* avoid iOS zoom */
}


/* === Prune columns & mobile keep-list (injected) === */
th.col-slot, td.col-slot,
th.col-status, td.col-status,
th.col-total, td.col-total {
  display: none !important;
}

@media (max-width: 600px) {
  table td { display: none !important; }
  table td.keep-mobile { display: block !important; }
}


@media (max-width: 768px) {
  /* åªé‡å°é¡¯ç¤ºæœªæ’æœŸçš„ pill åšæ©«å‘è²¼é½Šä¿®æ­£ */
  .toolbar label.pill {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    justify-content: flex-start !important;
    font-size: 13px !important;
    gap: 8px !important;
    width: 100% !important;
    min-width: 0;
    margin: 0;
    padding: 0 14px !important;
    height: 44px;
    box-sizing: border-box;
  }
  .toolbar label.pill input[type="checkbox"] {
    margin-right: 8px;
    margin-left: 0;
    width: 22px;
    height: 22px;
    accent-color: #2563eb;
    flex-shrink: 0;
  }
  .toolbar label.pill span {
    flex: 1 1 auto;
    font-size: 14px !important;
    letter-spacing: 0.01em;
    white-space: nowrap;
    padding-left: 2px;
    display: block;
  }
}
</style>
<script defer="True" src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script></head>
<body>
<header>
<div class="wrap toolbar">
<div class="pill">
<strong>æœˆä»½</strong>
<select id="yearSel"><option value="è‡ªç„¶å¤§å”"></option></select>
<select id="monthSel"></select>
</div>
<div class="pill">
<strong>ä½œæ¥­äººå“¡</strong>
<select id="staffFilter"></select>
</div>
<div class="pill">
<strong>ç‹€æ³</strong>
<select id="statusFilter">
<option value="">å…¨éƒ¨</option>
<option value="æ’å®š">æ’å®š</option>
<option value="å®Œæˆ">å®Œæˆ</option>
<option value="æœªå®Œæˆ">æœªå®Œæˆ</option>
</select>
</div>
<div class="pill">
<strong>å®Œæˆæ™‚é–“</strong>
<select id="completedRange">
<option value="">å…¨éƒ¨</option>
<option value="7">è¿‘7å¤©</option>
<option value="30">è¿‘30å¤©</option>
</select>
</div>
<label class="pill" style="gap:8px">
<input checked="" id="showUndated" type="checkbox"/>
<span>é¡¯ç¤ºæœªæ’æœŸ</span>
</label>
<div class="pill">
<strong>æœå°‹</strong>
<input id="searchInput" placeholder="å§“å / é›»è©± / åœ°å€" style="width:220px" type="text"/>
</div>
<div class="right"><button class="accent" id="gdriveBackupBtn" onclick="initGoogleBackup()">â˜ï¸Google</button>
<button class="accent" id="newBtn">æ–°å¢è¨‚å–®</button>
<button id="newExpenseBtn">æ–°å¢èŠ±è²»</button>
<button id="exportJson">åŒ¯å‡ºJSON</button>
<button id="exportXlsx">åŒ¯å‡ºExcel</button>
<button class="warn" id="importJson">åŒ¯å…¥JSON</button>
<button class="danger" id="clearAll">æ¸…ç©ºè³‡æ–™</button></div>
</div>
</header>
<main class="wrap stack" style="margin-top:16px">
<!-- è¨‚å–®åˆ—è¡¨ï¼ˆä¸Šï¼‰ -->
<section class="card">
<h2>è¨‚å–®åˆ—è¡¨</h2>
<div class="body">
<div class="sum" id="summary"></div>
<div class="hr"></div>
<div class="small muted">å°æŠ€å·§ï¼š
        1) é»ã€Œç‹€æ³ã€ç±¤å¯å¿«é€Ÿåˆ‡æ›ï¼ˆæ’å®š â†’ å®Œæˆ â†’ æœªå®Œæˆï¼‰ã€‚
        2) ç›´æ¥é»ã€Œæ—¥æœŸã€æˆ–ã€Œæ™‚é–“ã€æ¬„å¯å¿«é€Ÿç·¨è¼¯ï¼›Enter/å¤±ç„¦å„²å­˜ï¼ŒEsc å–æ¶ˆã€‚ 3) å³ä¸Šå¯ç”¨é—œéµå­—æœå°‹ï¼ˆå§“å/é›»è©±/åœ°å€ï¼‰ï¼Œçµæœæœƒè‡ªå‹•é«˜äº®ã€‚
        æœªå¡«æ—¥æœŸæœƒæ¨™è¨˜ <span class="badge-soft">æœªæ’æœŸ</span>ã€æœªå¡«æ™‚é–“æœƒæ¨™è¨˜ <span class="badge-soft">æœªæ’å®š</span>ã€‚</div>
<div style="overflow:auto;margin-top:8px">
<table id="ordersTable">
<thead>
<tr>
<th>#</th>
<th>æ—¥æœŸ</th>
<th>æ™‚é–“</th>
<th>ä½œæ¥­äººå“¡</th>
<th>å®¢æˆ¶</th>
<th>é›»è©±</th>
<th class="col-slot">æ™‚æ®µ</th>
<th>åœ°å€</th>
<th class="col-status">ç‹€æ³</th>
<th>ç¢ºèª</th>
<th>å ±åƒ¹å–®</th>
<th class="right-align col-total">ç¸½é‡‘é¡</th>
<th class="right-align">æŠ˜å¾Œ</th>
<th>ä¾†æº</th>
<th>æ“ä½œ</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
</section>
<!-- è¨‚å–®è¡¨å–®ï¼ˆä¸­ï¼‰ -->
<details ="true"="" class="accordion" id="orderAccordion"><summary><span id="formTitle">æ–°å¢ / ç·¨è¼¯è¨‚å–®</span></summary><div class="content">
<form id="orderForm">
<input id="id" type="hidden"/>
<div class="row">
<div class="col" style="grid-column:span 6">
<label>ä½œæ¥­äººå“¡</label>
<div class="toolbar" style="gap:8px">
<select id="staff"><option value="é€å¤©å±‹"></option><option value="å¤§æ¨“(æœ‰é›»æ¢¯)"></option><option value="å¤§æ¨“(ç„¡é›»æ¢¯)"></option><option value="å…¶ä»–(å¯è‡ªè¡Œè¼¸å…¥)"></option></select>
<button class="inline-btn" id="addStaffBtn" type="button">æ–°å¢äººå“¡</button>
</div>
</div>
<div class="col" style="grid-column:span 3">
<label>æ—¥æœŸï¼ˆå¯ç•™ç©ºï¼Œä¹‹å¾Œå†å¡«ï¼‰</label>
<input id="date" type="date"/>
</div>
<div class="col" style="grid-column:span 3">
<label>æ™‚é–“</label>
<input id="time" type="time"/>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 6">
<label>å§“åï¼ˆæ”¯æ´é€šè¨ŠéŒ„ï¼‰</label>
<input id="customer" list="contactsDL" placeholder="å®¢æˆ¶å§“å" type="text"/>
<datalist id="contactsDL"></datalist>
<div class="tiny">é¸æ—¢æœ‰å®¢æˆ¶æœƒè‡ªå‹•å¸¶å‡ºé›»è©±/åœ°å€</div>
</div>
<div class="col" style="grid-column:span 3">
<label>LINE or Fackbook ID</label>
<input id="lineId" type="text"/>
</div>
<div class="col" style="grid-column:span 3">
<label>é›»è©±</label>
<input id="phone" placeholder="0912-345-678ï¼ˆå¯å« - ï¼‰" type="text"/>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 5">
<label>å®‰æ’æ™‚æ®µï¼ˆå¯è¤‡é¸ï¼‰</label>
<div class="checkbox-group" id="slotGroup"></div>
<input class="hidden tiny" id="slotNote" placeholder="è«‹è¼¸å…¥æŒ‡å®šæ—¥æœŸï¼æ™‚æ®µï¼ˆå¦‚ 10/10 ä¸Šåˆ æˆ– 10/12 9:00â€“12:00ï¼‰" type="text"/>
</div>
<div class="col" style="grid-column:span 7">
<label>æ¸…æ´—åœ°å€</label>
<input id="address" placeholder="åœ°å€" type="text"/>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 6">
<label>å±…ä½åœ°å‹æ…‹</label>
<div class="toolbar" style="gap:8px">
<select id="residenceType">
<option value="">ï¼ˆæœªé¸æ“‡ï¼‰</option>
<option value="é€å¤©å±‹">é€å¤©å±‹</option>
<option value="å¤§æ¨“(æœ‰é›»æ¢¯)">å¤§æ¨“(æœ‰é›»æ¢¯)</option>
<option value="å¤§æ¨“(ç„¡é›»æ¢¯)">å¤§æ¨“(ç„¡é›»æ¢¯)</option>
<option value="å…¶ä»–">å…¶ä»–ï¼ˆå¯è‡ªè¡Œè¼¸å…¥ï¼‰</option>
</select>
<input class="hidden" id="residenceOther" placeholder="è«‹è¼¸å…¥å…¶ä»–å‹æ…‹" type="text"/>
</div>
</div>
<div class="col" style="grid-column:span 6">
<label>æ–¹ä¾¿è¯ç¹«æ™‚é–“ï¼ˆå¯è¤‡é¸ï¼‰</label>
<div class="checkbox-group" id="contactTimesGroup"></div>
<input class="hidden tiny" id="contactTimeNote" placeholder="è«‹è¼¸å…¥æŒ‡å®šæ™‚é–“ï¼ˆå¦‚ 9:00â€“12:00 æˆ– é€±ä¸‰æ™šä¸Šï¼‰" type="text"/>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 6">
<label>å†·æ°£ä½æ–¼æ¨“å±¤ï¼ˆå¯è¤‡é¸ï¼‰</label>
<div class="checkbox-group" id="acFloors"></div>
</div>
<div class="col" style="grid-column:span 6">
<label>æ´—è¡£æ©Ÿä½æ–¼æ¨“å±¤ï¼ˆå¯è¤‡é¸ï¼‰</label>
<div class="checkbox-group" id="washerFloors"></div>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 8">
<label>èˆ‡æˆ‘å¸è¯ç¹«æ–¹å¼</label>
<div class="toolbar" style="gap:8px">
<select id="contactMethod"></select>
<button class="inline-btn" id="addContactMethod" type="button">æ–°å¢è¯ç¹«æ–¹å¼</button>
</div>
</div>
<div class="col" style="grid-column:span 4">
<label>ç‹€æ³</label>
<select id="status">
<option value="æ’å®š">æ’å®š</option>
<option value="å®Œæˆ">å®Œæˆ</option>
<option value="æœªå®Œæˆ">æœªå®Œæˆ</option>
</select>
</div>
</div>
<div class="hr"></div>
<h3 style="margin:0 0 8px">æ¸…æ´—é …ç›®èˆ‡åƒ¹æ ¼</h3>
<div class="row">
<div class="col" style="grid-column:span 6">
<label>åˆ†é›¢å¼å†·æ°£å®¤å…§æ©Ÿï¼ˆæ¯å°1800ï¼›æ»¿3å°æ¯å°1500ï¼‰</label>
<input id="acSplit" min="0" step="1" type="number" value="0"/>
</div>
<div class="col" style="grid-column:span 6">
<label>åŠéš±å¼å†·æ°£ï¼ˆæ¯å°2800ï¼‰</label>
<input id="acDuct" min="0" step="1" type="number" value="0"/>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 6">
<label>ç›´ç«‹å¼æ´—è¡£æ©Ÿï¼ˆæ¯å°2000ï¼›è‹¥åŒå–®å«å†·æ°£å®¤å…§æ©Ÿå‰‡æ¯å°1800ï¼‰</label>
<input id="washerTop" min="0" step="1" type="number" value="0"/>
</div>
<div class="col" style="grid-column:span 6">
<label>æ°´å¡”ï¼ˆæ¯é¡†1000ï¼‰</label>
<input id="waterTank" min="0" step="1" type="number" value="0"/>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 6">
<label>è‡ªä¾†æ°´ç®¡ï¼ˆè‡ªè¨‚é‡‘é¡ï¼Œæœªç¨…ç¸½é¡ï¼‰</label>
<input id="pipesAmount" min="0" step="1" type="number" value="0"/>
</div>
<div class="col" style="grid-column:span 6">
<label>é˜²éœ‰å™´åŠ‘ï¼ˆæ¯å°300ï¼›æ»¿5å°æ¯å°250ï¼‰</label>
<input id="antiMold" min="0" step="1" type="number" value="0"/>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 6">
<label>è‡­æ°§æ®ºèŒï¼ˆæ¯é–“200ï¼‰</label>
<input id="ozone" min="0" step="1" type="number" value="0"/>
</div>
<div class="col" style="grid-column:span 6">
<label>è®Šå½¢é‡‘å‰›æ©Ÿå‹ï¼ˆæ¯å°åŠ 500ï¼‰</label>
<input id="transformerCount" min="0" step="1" type="number" value="0"/>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 6">
<label>åˆ†é›¢å¼å®¤å…§æ©Ÿé•·åº¦ &gt; 182cmï¼ˆæ¯å°åŠ 300ï¼‰</label>
<input id="longSplitCount" min="0" step="1" type="number" value="0"/>
</div>
<div class="col" style="grid-column:span 6">
<label>ä¸€é«”å¼æ°´ç›¤ï¼ˆæ¯å°åŠ 500ï¼‰</label>
<input id="onePieceTray" min="0" step="1" type="number" value="0"/>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 12">
<label>å‚™è¨»</label>
<textarea id="note" placeholder="å…¶ä»–è£œå……äº‹é …"></textarea>
</div>
</div>
<div class="hr"></div>
<div class="row">
<div class="col" style="grid-column:span 4">
<label><input id="confirmed" type="checkbox"/> å®¢äººç¢ºèªå®‰æ’æ™‚é–“</label>
</div>
<div class="col" style="grid-column:span 4">
<label><input id="quotationOk" type="checkbox"/> å®¢äººç¢ºèªå ±åƒ¹å–®</label>
</div>
<div class="col right-align" style="grid-column:span 4">
<button class="inline-btn" id="recalc" type="button">é‡æ–°è¨ˆç®—é‡‘é¡</button>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 4">
<label>ç¸½é‡‘é¡ï¼ˆè‡ªå‹•ï¼‰</label>
<input id="total" readonly="" type="number"/>
</div>
<div class="col" style="grid-column:span 4">
<label>æŠ˜æ‰£é‡‘é¡ï¼ˆå¯è¼¸å…¥ï¼‰</label>
<input id="discount" min="0" step="1" type="number" value="0"/>
</div>
<div class="col" style="grid-column:span 4">
<label>æŠ˜å¾Œç¸½é‡‘é¡ï¼ˆè‡ªå‹•ï¼‰</label>
<input id="netTotal" readonly="" type="number"/>
</div>
</div>
<div class="hr"></div>
<div class="toolbar">
<button class="primary" id="saveBtn" type="submit">å„²å­˜è¨‚å–®</button>
<button id="resetBtn" type="button">æ¸…ç©ºè¡¨å–®</button>
<button id="copyLastBtn" type="button">è¤‡è£½ä¸Šä¸€ç­†</button>
<button id="copyFromHistoryBtn" type="button">å¾å®¢æˆ¶èˆŠå–®å¸¶å…¥</button>
<div class="right">
<span class="lock-badge" id="lockInfo"></span>
<div style="display:inline-block; margin-right:8px;"><label style="margin-right:4px;">æ™‚é•·(åˆ†)</label><input id="durationMinutes" min="15" step="15" style="width:70px;" type="number" value="120"/></div><button class="btn" onclick="handleUploadWithAuth(gatherForm())">ğŸ“…</button><button class="warn" id="toggleLock" type="button">è§£é–é‡‘é¡ç·¨è¼¯</button>
<button class="danger" disabled="" id="deleteBtn" type="button">åˆªé™¤æ­¤è¨‚å–®</button>
</div>
</div>
</form>
</div></details>
<!-- æ”¯å‡ºæ¨¡çµ„ï¼ˆä¸‹ï¼‰ä»¥æ‰‹é¢¨ç´å‘ˆç¾ -->
<details =""="" class="accordion" id="expenseAcc">
<summary>æœ¬æœˆèŠ±è²»ï¼ˆå¯å±•é–‹/æ”¶åˆï¼‰</summary>
<div class="content">
<div class="two-col">
<section class="card" style="border:none;box-shadow:none">
<h2>æœ¬æœˆèŠ±è²»åˆ—è¡¨</h2>
<div class="body">
<div class="toolbar" style="margin-bottom:8px">
<button id="expExportCsv">åŒ¯å‡ºèŠ±è²»CSV</button>
<button id="expExportJson">åŒ¯å‡ºèŠ±è²»JSON</button>
<button class="warn" id="expImportJson">åŒ¯å…¥èŠ±è²»JSON</button>
<button class="danger" id="expClear">æ¸…ç©ºèŠ±è²»</button>
</div>
<div style="overflow:auto">
<table id="expenseTable">
<thead>
<tr>
<th>#</th>
<th>æ—¥æœŸ</th>
<th>é¡åˆ¥</th>
<th>èªªæ˜</th>
<th class="right-align">é‡‘é¡</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
</section>
<aside class="card" style="border:none;box-shadow:none">
<h2>æ–°å¢ / ç·¨è¼¯èŠ±è²»</h2>
<div class="body">
<form id="expenseForm">
<input id="expId" type="hidden"/>
<div class="row">
<div class="col" style="grid-column:span 4">
<label>æ—¥æœŸ</label>
<input id="expDate" type="date"/>
</div><div class="col" style="grid-column:span 3"><label>å·¥ä½œæ™‚é•·ï¼ˆåˆ†é˜ï¼‰</label><input id="durationMinutes" min="15" step="15" type="number" value="120"/></div>
<div class="col" style="grid-column:span 4">
<label>é¡åˆ¥</label>
<div class="toolbar" style="gap:8px">
<select id="expCategory"></select>
<button class="inline-btn" id="addExpCat" type="button">æ–°å¢é¡åˆ¥</button>
</div>
</div>
<div class="col" style="grid-column:span 4">
<label>é‡‘é¡</label>
<input id="expAmount" min="0" step="1" type="number" value="0"/>
</div>
</div>
<div class="row">
<div class="col" style="grid-column:span 12">
<label>èªªæ˜</label>
<input id="expNote" placeholder="ä¾‹å¦‚ï¼šææ–™ã€åŠ æ²¹ã€åœè»Šã€å·¥å…·ç¶­ä¿®â€¦" type="text"/>
</div>
</div>
<div class="toolbar">
<button class="primary" id="expSave" type="submit">å„²å­˜èŠ±è²»</button>
<button id="expReset" type="button">æ¸…ç©ºè¡¨å–®</button>
<div class="right">
<button class="danger" disabled="" id="expDelete" type="button">åˆªé™¤æ­¤ç­†èŠ±è²»</button>
</div>
</div>
</form>
</div>
</aside>
</div>
</div>
</details>
</main>
<input accept=".json" class="hidden" id="filePicker" type="file"/>
<input accept=".json" class="hidden" id="filePickerExp" type="file"/>
<template id="expRowTpl">
<tr>
<td class="small muted"></td>
<td></td><td></td><td></td><td class="right-align"></td>
</tr>
</template>
<script>
    // ---------- Utilities ----------
    const $ = (id) => document.getElementById(id);
    const fmtCurrency = n => Number(n||0).toLocaleString('zh-TW', {style:'currency', currency:'TWD', maximumFractionDigits:0});
    const today = new Date();
    const pad2 = n => n.toString().padStart(2,'0');
    const SLOT_OPTS = ['å¹³æ—¥','å‡æ—¥','ä¸Šåˆ','ä¸‹åˆ','çš†å¯','æ—¥æœŸæŒ‡å®š'];
    const CONTACT_TIME_OPTS = ['å¹³æ—¥','å‡æ—¥','ä¸Šåˆ','ä¸‹åˆ','æ™šä¸Š','çš†å¯','æ™‚é–“æŒ‡å®š'];
    const FLOOR_OPTS = ['1F','2F','3F','4F','5F','æœ‰é›»æ¢¯'];
    const STATUS_FLOW = ['æ’å®š','å®Œæˆ','æœªå®Œæˆ'];

    function renderChecks(containerId, options, name){
      const el = $(containerId);
      el.innerHTML = options.map(opt => `<label class="checkbox"><input type="checkbox" data-name="${name}" value="${opt}"><span>${opt}</span></label>`).join('');
    }
    function getChecked(name){ return Array.from(document.querySelectorAll('input[type="checkbox"][data-name="'+name+'"]:checked')).map(x=>x.value); }
    function setChecked(name, values){ const set = new Set(values||[]); document.querySelectorAll('input[type="checkbox"][data-name="'+name+'"]').forEach(x=> x.checked = set.has(x.value)); }

    // ---------- Storage ----------
    const KEY = 'yl_clean_orders_v1';
    const STAFF_KEY = 'yl_clean_staff_v1';
    const CONTACT_KEY = 'yl_clean_contact_v1';
    const EXP_KEY = 'yl_clean_expenses_v1';
    const EXP_CAT_KEY = 'yl_clean_expense_categories_v1';
    const load = (k, fallback) => { try{ return JSON.parse(localStorage.getItem(k) || 'null') ?? fallback; }catch{ return fallback; } }
    const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    let orders = load(KEY, []);
    let staffList = load(STAFF_KEY, ['è‡ªç„¶å¤§å”']);
    let contactList = load(CONTACT_KEY, ['Line','Facebookç²‰çµ²åœ˜','ç›´æ¥ç·šä¸Šé ç´„','ç›´æ¥ä¾†é›»','è£•è‰¯é›»å™¨è¡Œ','å…¶ä»–']);
    let expenses = load(EXP_KEY, []);
    let expCats = load(EXP_CAT_KEY, ['ææ–™','åŠ æ²¹','åœè»Š','å·¥å…·/ç¶­ä¿®','å…¶ä»–']);


    const CONTACTS_KEY = 'yl_clean_contacts_v1';
    let contacts = load(CONTACTS_KEY, []); // {id,name,phone,address,lineId}
    function normalizePhone(p){ return (p||'').replace(/\D+/g,''); }
    function upsertContact(name, phone, address, lineId){
      const np = normalizePhone(phone);
      if(!name && !np) return;
      const idx = contacts.findIndex(c => normalizePhone(c.phone)===np && np);
      if(idx>=0){
        // merge
        contacts[idx].name = contacts[idx].name || name;
        contacts[idx].address = contacts[idx].address || address;
        contacts[idx].lineId = contacts[idx].lineId || lineId;
      }else{
        contacts.push({id: crypto.randomUUID(), name: name||'', phone: phone||'', address: address||'', lineId: lineId||''});
      }
      save(CONTACTS_KEY, contacts);
      refreshContactsDatalist();
    }
    function findContactByName(name){
      const n=(name||'').trim();
      if(!n) return null;
      const list = contacts.filter(c => (c.name||'')===n);
      if(list.length===1) return list[0];
      return null;
    }
    function findContactByPhone(phone){
      const np = normalizePhone(phone);
      if(!np) return null;
      return contacts.find(c => normalizePhone(c.phone)===np) || null;
    }
    function refreshContactsDatalist(){
      const dl = document.getElementById('contactsDL');
      if(!dl) return;
      dl.innerHTML = contacts.map(c => `<option value="${(c.name||'')}" label="${(c.phone||'')} ${(c.address||'')}"></option>`).join('');
    }


    // ---------- Init ----------
    function initYearMonth(){
      const yearSel = $('yearSel'), monthSel = $('monthSel');
      const yearNow = new Date().getFullYear();
      const years = []; for(let y=yearNow-3;y<=yearNow+3;y++) years.push(y);
      yearSel.innerHTML = years.map(y=>`<option value="${y}" ${y===yearNow?'selected':''}>${y} å¹´</option>`).join('');
      monthSel.innerHTML = Array.from({length:12},(_,i)=>i+1).map(m=>`<option value="${m}" ${m===today.getMonth()+1?'selected':''}>${m} æœˆ</option>`).join('');
      yearSel.onchange = monthSel.onchange = ()=>{ refreshTable(); refreshExpense(); };
      $('showUndated').onchange = refreshTable;
    }
    function initFilters(){
      $('staffFilter').innerHTML = ['å…¨éƒ¨',...staffList].map(s=>`<option value="${s==='å…¨éƒ¨'?'':s}">${s}</option>`).join('');
      $('staffFilter').onchange = refreshTable;
      $('statusFilter').onchange = refreshTable;
      $('completedRange').onchange = refreshTable;
      $('searchInput').addEventListener('input', refreshTable);
    }
    function initStaffSelects(){ $('staff').innerHTML = staffList.map(s=>`<option value="${s}">${s}</option>`).join(''); initFilters(); }
    function initContactSelect(){ $('contactMethod').innerHTML = contactList.map(c=>`<option value="${c}">${c}</option>`).join(''); }
    function initCheckboxes(){ renderChecks('slotGroup', SLOT_OPTS, 'slot'); renderChecks('contactTimesGroup', CONTACT_TIME_OPTS, 'contactTime'); renderChecks('acFloors', FLOOR_OPTS, 'acFloor'); renderChecks('washerFloors', FLOOR_OPTS, 'washerFloor'); }
    function initExpenseCats(){ $('expCategory').innerHTML = expCats.map(c=>`<option value="${c}">${c}</option>`).join(''); }

    // ---------- Pricing ----------
    function calcTotal(f){
      const acSplit=+f.acSplit||0, acDuct=+f.acDuct||0, washerTop=+f.washerTop||0, waterTank=+f.waterTank||0;
      const pipesAmount=+f.pipesAmount||0, antiMold=+f.antiMold||0, ozone=+f.ozone||0, transformerCount=+f.transformerCount||0;
      const longSplitCount=+f.longSplitCount||0, onePieceTray=+f.onePieceTray||0;
      const splitTotal=acSplit*(acSplit>=3?1500:1800), ductTotal=acDuct*2800, washerTotal=washerTop*((acSplit+acDuct)>0?1800:2000);
      const tankTotal=waterTank*1000, pipesTotal=Math.max(0,pipesAmount), antiMoldTotal=antiMold*(antiMold>=5?250:300);
      const ozoneTotal=ozone*200, transformerTotal=transformerCount*500, longSplitTotal=longSplitCount*300, onePieceTotal=onePieceTray*500;
      return Math.max(0, Math.round(splitTotal+ductTotal+washerTotal+tankTotal+pipesTotal+antiMoldTotal+ozoneTotal+transformerTotal+longSplitTotal+onePieceTotal));
    }
    function gatherForm(){
      return {
    durationMinutes: +$('durationMinutes').value || 120,
    durationMinutes: +$('durationMinutes').value || 120,
        id: $('id').value || crypto.randomUUID(),
        staff:$('staff').value, date:$('date').value, time:$('time').value,
        confirmed:$('confirmed')?.checked||false, quotationOk:$('quotationOk')?.checked||false,
        customer:$('customer').value.trim(), lineId:$('lineId').value.trim(), phone:$('phone').value.trim(),
        slots:getChecked('slot'), slotNote:$('slotNote')?.value.trim()||'', address:$('address').value.trim(),
        residenceType:$('residenceType')?.value||'', residenceOther:$('residenceOther')?.value.trim()||'',
        contactTimes:getChecked('contactTime'), contactTimeNote:$('contactTimeNote')?.value.trim()||'',
        acFloors:getChecked('acFloor'), washerFloors:getChecked('washerFloor'),
        contactMethod:$('contactMethod').value, status:$('status').value,
        acSplit:+$('acSplit').value||0, acDuct:+$('acDuct').value||0, washerTop:+$('washerTop').value||0, waterTank:+$('waterTank').value||0,
        pipesAmount:+$('pipesAmount').value||0, antiMold:+$('antiMold').value||0, ozone:+$('ozone').value||0,
        transformerCount:+$('transformerCount').value||0, longSplitCount:+$('longSplitCount').value||0, onePieceTray:+$('onePieceTray').value||0,
        note:$('note').value.trim(), total:+$('total').value||0, discount:+$('discount').value||0, netTotal:+$('netTotal').value||0,
        createdAt:$('id').value ? undefined : new Date().toISOString()
      };
    }
    function fillForm(o){
      $('orderAccordion').open = true; $('orderAccordion').scrollIntoView({behavior:'smooth', block:'start'});
      $('id').value=o.id||''; $('staff').value=o.staff||staffList[0];
      $('date').value=o.date||''; $('time').value=o.time||'';
      $('confirmed').checked=!!o.confirmed; $('quotationOk').checked=!!o.quotationOk;
      $('customer').value=o.customer||''; $('lineId').value=o.lineId||''; $('phone').value=o.phone||'';
      setChecked('slot', o.slots||[]); $('slotNote').value=o.slotNote||''; $('slotNote').classList.toggle('hidden', !((o.slots||[]).includes('æ—¥æœŸæŒ‡å®š') || (o.slots||[]).includes('æ™‚é–“æŒ‡å®š'))); $('address').value=o.address||'';
      $('residenceType').value=o.residenceType||''; $('residenceOther').value=o.residenceOther||''; $('residenceOther').classList.toggle('hidden', (o.residenceType||'')!=='å…¶ä»–');
      setChecked('contactTime', o.contactTimes||[]); $('contactTimeNote').value=o.contactTimeNote||''; $('contactTimeNote').classList.toggle('hidden', !(o.contactTimes||[]).includes('æ™‚é–“æŒ‡å®š'));
      setChecked('acFloor', o.acFloors||[]); setChecked('washerFloor', o.washerFloors||[]);
      $('contactMethod').value=o.contactMethod||contactList[0]; $('status').value=o.status||'æ’å®š';
      $('acSplit').value=o.acSplit||0; $('acDuct').value=o.acDuct||0; $('washerTop').value=o.washerTop||0; $('waterTank').value=o.waterTank||0;
      $('pipesAmount').value=o.pipesAmount||0; $('antiMold').value=o.antiMold||0; $('ozone').value=o.ozone||0;
      $('transformerCount').value=o.transformerCount||0; $('longSplitCount').value=o.longSplitCount||0; $('onePieceTray').value=o.onePieceTray||0;
      $('note').value=o.note||''; $('discount').value=o.discount||0; $('total').value=o.total||0; $('netTotal').value=o.netTotal||0;
      $('deleteBtn').disabled=!o.id; $('formTitle').textContent=o.id?'ç·¨è¼¯è¨‚å–®':'æ–°å¢è¨‚å–®';
      setFormLock(!!o.locked);
      if(o.completedAt){ $('lockInfo').textContent = 'å®Œæˆæ–¼ ' + new Date(o.completedAt).toLocaleString(); }
    }
    function recalcTotals(){ const total=calcTotal(gatherForm()); $('total').value=total; const discount=Math.max(0,+$('discount').value||0); $('netTotal').value=Math.max(0,total-discount); }

    function setFormLock(lock){
      const ids=['acSplit','acDuct','washerTop','waterTank','pipesAmount','antiMold','ozone','transformerCount','longSplitCount','onePieceTray','discount','recalc'];
      ids.forEach(id=>{ const el=$(id); if(el){ el.disabled = !!lock; el.readOnly = !!lock; }});
      $('toggleLock').textContent = lock ? 'è§£é™¤é–å®šï¼ˆå…è¨±ä¿®æ”¹ï¼‰' : 'è§£é–é‡‘é¡ç·¨è¼¯';
      $('lockInfo').textContent = lock ? 'é‡‘é¡å·²é–å®šï¼ˆå®Œæˆï¼‰' : '';
    }


    // ---------- Table & quick status ----------
    function nextStatus(s){ const i=STATUS_FLOW.indexOf(s); return STATUS_FLOW[(i+1)%STATUS_FLOW.length]; }
    function refreshTable(){
      const y=+$('yearSel').value, m=+$('monthSel').value, staffF=$('staffFilter').value, statusF=$('statusFilter').value, showUndated=$('showUndated').checked;
      const tbody=$('ordersTable').querySelector('tbody'); tbody.innerHTML='';
      const q = ($('searchInput')?.value || '').trim();
      const tokens = q ? q.split(/\s+/).map(t=>t.toLowerCase().replace(/\s|-/g,'')) : [];
      searchTokens = (q ? q.split(/\s+/) : []).filter(Boolean); // for highlight (not normalized)
      const hay = (o)=>[o.customer||'', o.phone||'', o.address||''].join(' ').toLowerCase().replace(/\s|-/g,'');
      const range=$('completedRange').value;
      const now=Date.now();
      const filtered=orders.filter(o=>{
        const s1=!staffF || o.staff===staffF; const s2=!statusF || o.status===statusF;
        const condQuery = tokens.length===0 || tokens.every(t => hay(o).includes(t));
        const condRange = !range || (o.completedAt && (now - new Date(o.completedAt).getTime()) <= (+range)*24*60*60*1000);
        if(!o.date){ return showUndated && s1 && s2 && condQuery && condRange; }
        const d=new Date(o.date); const ym=(d.getFullYear()===y && (d.getMonth()+1)===m);
        return ym && s1 && s2 && condQuery && condRange;
      }).sort((a,b)=>{
        if(!a.date && b.date) return -1;
        if(a.date && !b.date) return 1;
        const dc = (a.date||'9999-99-99').localeCompare(b.date||'9999-99-99');
        if(dc!==0) return dc;
        if(!a.time && b.time) return -1;
        if(a.time && !b.time) return 1;
        return (a.time||'').localeCompare(b.time||'');
      });

      filtered.forEach((o,idx)=>{
        const tr=document.createElement('tr');
        const dateCell = o.date ? o.date : '<span class="badge-soft">æœªæ’æœŸ</span>';
        tr.innerHTML=`
          <td class="small muted" data-label="#">${idx+1}</td>
          <td class="editable" data-label="æ—¥æœŸ">${dateCell}</td>
          <td class="editable" data-label="æ™‚é–“">${o.time ? o.time : '<span class=\"badge-soft\">æœªæ’å®š</span>'}</td>
          <td data-label="ä½œæ¥­äººå“¡">${o.staff||''}</td>
          <td data-label="å®¢æˆ¶">${o.customer||''}</td>
          <td data-label="é›»è©±">${o.phone||''}</td>
          <td data-label="æ™‚æ®µ">${(o.slots||[]).join('ã€')}</td>
          <td data-label="åœ°å€">${o.address||''}</td>
          <td data-label="ç‹€æ³"></td>
          <td class="toggle-confirm" data-label="ç¢ºèª"></td>
          <td class="toggle-quote" data-label="å ±åƒ¹å–®"></td>
          <td class="right-align" data-label="ç¸½é‡‘é¡">${fmtCurrency(o.total||0)}</td>
          <td class="right-align" data-label="æŠ˜å¾Œ">${fmtCurrency(o.netTotal||0)}</td>
          <td data-label="ä¾†æº">${o.contactMethod||''}</td>
          <td class="op-cell" data-label="æ“ä½œ"></td`;
        const st=o.status||'æ’å®š';
        const span=document.createElement('span');
        span.className='status ' + (st==='æ’å®š'?'Pæ’å®š': st==='å®Œæˆ'?'Cå®Œæˆ':'Næœªå®Œæˆ');
        span.textContent=st; span.title='é»ä¸€ä¸‹å¿«é€Ÿåˆ‡æ›ç‹€æ³' + (o.completedAt? ('\nå®Œæˆæ–¼ï¼š'+ new Date(o.completedAt).toLocaleString()) : '');
        span.addEventListener('click',(ev)=>{
          ev.stopPropagation();
          const i=orders.findIndex(x=>x.id===o.id);
          if(i>=0){ const prev=orders[i].status||'æ’å®š'; const next=nextStatus(prev); orders[i].status=next; if(next==='å®Œæˆ'){ orders[i].completedAt=new Date().toISOString(); orders[i].locked=true; } else { orders[i].completedAt=undefined; orders[i].locked=false; } save(KEY, orders); refreshTable(); }
        });
        tr.children[8].appendChild(span);
        tr.addEventListener('click', ()=>{ fillForm(o); });
        const dateTd = tr.children[1];
        const timeTd = tr.children[2];
        dateTd.addEventListener('click', (ev)=>{ ev.stopPropagation(); startInlineEdit(dateTd, 'date', o); });
        timeTd.addEventListener('click', (ev)=>{ ev.stopPropagation(); startInlineEdit(timeTd, 'time', o); });
        // highlight cells for search
        tr.children[4].innerHTML = highlightText(o.customer||'');
        tr.children[5].innerHTML = highlightPhone(o.phone||'');
        tr.children[7].innerHTML = highlightText(o.address||'');
        // render toggle confirm
        const ctd = tr.querySelector('.toggle-confirm');
        const qtd = tr.querySelector('.toggle-quote');
        const cspan = renderTogglePill(ctd, !!o.confirmed, 'å·²ç¢ºèª', 'æœªç¢ºèª');
        const qspan = renderTogglePill(qtd, !!o.quotationOk, 'å·²ç¢ºèª', 'æœªç¢ºèª');
        cspan.addEventListener('click', (ev)=>{ ev.stopPropagation(); const i=orders.findIndex(x=>x.id===o.id); if(i>=0){ orders[i].confirmed = !orders[i].confirmed; save(KEY, orders); refreshTable(); }});
        qspan.addEventListener('click', (ev)=>{ ev.stopPropagation(); const i=orders.findIndex(x=>x.id===o.id); if(i>=0){ orders[i].quotationOk = !orders[i].quotationOk; save(KEY, orders); refreshTable(); }});
        // quick delete button
        const op = tr.querySelector('.op-cell');
        const copyBtn = document.createElement('button'); copyBtn.className='icon-btn'; copyBtn.textContent='è¤‡è£½';
        copyBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); copyOrderFrom(o); });
        op.appendChild(copyBtn);
        const delBtn = document.createElement('button'); delBtn.className='icon-btn danger'; delBtn.textContent='åˆªé™¤';
        delBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨‚å–®å—ï¼Ÿ')){ orders = orders.filter(x=>x.id!==o.id); save(KEY, orders); refreshTable(); }});
        op.appendChild(delBtn);
        
        // === Mobile keep list ===
        // idx: 1:æ—¥æœŸ 2:æ™‚é–“ 4:å®¢æˆ¶ 5:é›»è©± 7:åœ°å€ 9:ç¢ºèª 10:å ±åƒ¹å–® 12:æŠ˜å¾Œ 14:æ“ä½œ
        try {
          tr.children[1]?.classList.add('keep-mobile');   // æ—¥æœŸ
          tr.children[2]?.classList.add('keep-mobile');   // æ™‚é–“
          tr.children[4]?.classList.add('keep-mobile');   // å®¢æˆ¶
          tr.children[5]?.classList.add('keep-mobile');   // é›»è©±
          tr.children[7]?.classList.add('keep-mobile');   // åœ°å€
          tr.querySelector('.toggle-confirm')?.classList.add('keep-mobile'); // ç¢ºèª
          tr.querySelector('.toggle-quote')?.classList.add('keep-mobile');   // å ±åƒ¹å–®
          tr.children[12]?.classList.add('keep-mobile');  // æŠ˜å¾Œ
          tr.querySelector('.op-cell')?.classList.add('keep-mobile');        // æ“ä½œ

          // === Permanently hidden columns (provide td class hooks) ===
          tr.children[6]?.classList.add('col-slot');      // æ™‚æ®µ
          tr.children[8]?.classList.add('col-status');    // ç‹€æ³
          tr.children[11]?.classList.add('col-total');    // ç¸½é‡‘é¡
        } catch(err) { /* noop */ }

        tbody.appendChild(tr);
      });
// Summary
      const sumEl=$('summary'); sumEl.innerHTML='';
      // Only include dated orders of the selected month for sums
      const monthly = orders.filter(o=> o.date && (new Date(o.date).getFullYear()===y) && (new Date(o.date).getMonth()+1===m));
      const count=monthly.length, total=monthly.reduce((a,b)=>a+(+b.total||0),0), net=monthly.reduce((a,b)=>a+(+b.netTotal||0),0);
      const done=monthly.filter(o=>o.status==='å®Œæˆ').length, pending=monthly.filter(o=>o.status!=='å®Œæˆ').length;
      const undatedCount = orders.filter(o=>!o.date).length;
      const monthExpense=expenses.filter(e=>{ if(!e.date) return false; const d=new Date(e.date); return d.getFullYear()===y && (d.getMonth()+1)===m; }).reduce((a,b)=>a+(+b.amount||0),0);
      const mk=(t,v,h='')=>{const box=document.createElement('div');box.className='box';box.innerHTML=`<div class="small muted">${t}</div><div class="number">${v}</div>${h?`<div class="small muted">${h}</div>`:''}`;return box;};
      sumEl.appendChild(mk('æœ¬æœˆè¨‚å–®æ•¸', count));
      sumEl.appendChild(mk('æœ¬æœˆç¸½é‡‘é¡', fmtCurrency(total)));
      sumEl.appendChild(mk('æœ¬æœˆæŠ˜å¾Œç¸½é‡‘é¡', fmtCurrency(net)));
      sumEl.appendChild(mk('æœ¬æœˆèŠ±è²»', fmtCurrency(monthExpense)));
      sumEl.appendChild(mk('æœ¬æœˆæ·¨æ”¶å…¥', fmtCurrency(Math.max(0, net - monthExpense))));
      sumEl.appendChild(mk('å®Œæˆ / æœªå®Œæˆ', `${done} / ${pending}`));
      if(undatedCount>0) sumEl.appendChild(mk('æœªæ’æœŸè¨‚å–®æ•¸', undatedCount, 'å¯å‹¾é¸ä¸Šæ–¹ã€Œé¡¯ç¤ºæœªæ’æœŸã€æŸ¥çœ‹'));
    }

    
    // ---------- Calendar Exports ----------
    function toTwo(n){ return n.toString().padStart(2,'0'); }
    function formatICSDateTimeLocal(dateStr, timeStr){
      // Returns YYYYMMDDTHHMMSS for local time (floating). For better TZ, user can import and choose timezone in Google Calendar.
      if(!dateStr) return '';
      const d = new Date(dateStr + 'T' + (timeStr||'09:00') + ':00');
      return d.getFullYear().toString()+toTwo(d.getMonth()+1)+toTwo(d.getDate())+'T'+toTwo(d.getHours())+toTwo(d.getMinutes())+'00';
    }
    function sanitizeText(t){ return (t||'').replace(/([,;])/g,'\\$1').replace(/\n/g,'\\n'); }

    function buildICSFromOrders(list){
      const lines = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//Yuliang Clean Scheduler//v8//ZH-TW'
      ];
      list.forEach(o=>{
        const dtStart = formatICSDateTimeLocal(o.date, o.time);
        if(!dtStart) return;
        // default duration 2 hours
        const dtEnd = formatICSDateTimeLocal(o.date, o.time ? o.time : '11:00');
        const title = sanitizeText(`${o.customer||'å®¢æˆ¶'} æ¸…æ´—å®‰æ’`);
        const staff = `ä½œæ¥­äººå“¡ï¼š${o.staff||''}`;
        const tel = `é›»è©±ï¼š${o.phone||''}`;
        const slots = `æ™‚æ®µï¼š${(o.slots||[]).join('ã€')}`;
        const price = `é‡‘é¡(æŠ˜å¾Œ)ï¼š${o.netTotal||o.total||0}`;
        const note = o.note ? `å‚™è¨»ï¼š${o.note}` : '';
        const desc = sanitizeText([staff, tel, slots, price, note].filter(Boolean).join('\\n'));
        const loc = sanitizeText(o.address||'');
        const uid = o.id || (dtStart + '@yl-clean');
        lines.push('BEGIN:VEVENT');
        lines.push('UID:'+uid);
        lines.push('DTSTAMP:'+formatICSDateTimeLocal(new Date().toISOString().slice(0,10), new Date().toTimeString().slice(0,5)));
        lines.push('DTSTART:'+dtStart);
        lines.push('DTEND:'+dtEnd);
        lines.push('SUMMARY:'+title);
        if(loc) lines.push('LOCATION:'+loc);
        if(desc) lines.push('DESCRIPTION:'+desc);
        lines.push('END:VEVENT');
      });
      lines.push('END:VCALENDAR');
      return lines.join('\r\n');
    }

    function exportICS(){
      // rule: only include orders with date & time present, and either å·²ç¢ºèªæ™‚é–“ æˆ– ç‹€æ³ç‚ºã€Œæ’å®š/å®Œæˆã€
      const y=+$('yearSel').value, m=+$('monthSel').value;
      const list = orders.filter(o=>{
        if(!o.date || !o.time) return false;
        const d=new Date(o.date);
        const inMonth = d.getFullYear()===y && (d.getMonth()+1)===m;
        const okStatus = ['æ’å®š','å®Œæˆ'].includes(o.status||'æ’å®š');
        const okConfirm = !!o.confirmed;
        return inMonth && okStatus && okConfirm;
      });
      if(list.length===0){ alert('æœ¬æœˆæ²’æœ‰ç¬¦åˆæ¢ä»¶ï¼ˆå·²ç¢ºèªä¸”æœ‰æ—¥æœŸèˆ‡æ™‚é–“ï¼‰çš„è¨‚å–®å¯åŒ¯å‡ºã€‚'); return; }
      const ics = buildICSFromOrders(list);
      download(`è¡Œäº‹æ›†_${y}-${toTwo(m)}.ics`, ics);
    }

    function exportGCalCsv(){
      // Google Calendar CSV columns: Subject, Start Date, Start Time, End Date, End Time, All Day Event, Description, Location
      const y=+$('yearSel').value, m=+$('monthSel').value;
      const headers = ['Subject','Start Date','Start Time','End Date','End Time','All Day Event','Description','Location'];
      const list = orders.filter(o=>{
        if(!o.date || !o.time) return false;
        const d=new Date(o.date);
        const inMonth = d.getFullYear()===y && (d.getMonth()+1)===m;
        const okStatus = ['æ’å®š','å®Œæˆ'].includes(o.status||'æ’å®š');
        const okConfirm = !!o.confirmed;
        return inMonth && okStatus && okConfirm;
      });
      if(list.length===0){ alert('æœ¬æœˆæ²’æœ‰ç¬¦åˆæ¢ä»¶ï¼ˆå·²ç¢ºèªä¸”æœ‰æ—¥æœŸèˆ‡æ™‚é–“ï¼‰çš„è¨‚å–®å¯åŒ¯å‡ºã€‚'); return; }
      const rows = list.map(o=>{
        const startDate = o.date.replace(/-/g,'/'); // mm/dd/yyyy also works; we'll keep yyyy/mm/dd is okay for import in Google Calendar if locale matches
        const startTime = o.time || '09:00';
        // default 2 hours duration
        const [hh,mm] = startTime.split(':').map(Number);
        const endH = (hh+2)%24; const endDate = o.date; // simplistic; if crossing midnight, ignore for now
        const endTime = (endH.toString().padStart(2,'0'))+':'+(mm.toString().padStart(2,'0'));
        const subject = `${o.customer||'å®¢æˆ¶'} æ¸…æ´—å®‰æ’`;
        const staff = `ä½œæ¥­äººå“¡ï¼š${o.staff||''}`;
        const tel = `é›»è©±ï¼š${o.phone||''}`;
        const slots = `æ™‚æ®µï¼š${(o.slots||[]).join('ã€')}`;
        const price = `é‡‘é¡(æŠ˜å¾Œ)ï¼š${o.netTotal||o.total||0}`;
        const note = o.note ? `å‚™è¨»ï¼š${o.note}` : '';
        const desc = [staff, tel, slots, price, note].filter(Boolean).join('\\n');
        const loc = o.address||'';
        return [subject, startDate, startTime, endDate, endTime, 'False', desc, loc];
      });
      const csv = [headers.join(','), ...rows.map(r=>r.map(x=>{
        const s=(x??'').toString();
        return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(','))].join('\n');
      download(`GoogleCalendar_${y}-${toTwo(m)}.csv`, csv);
    }

    
    
        // ---------- Excel Export (.xlsx) ----------
    function exportXLSX(){
      if (typeof XLSX === 'undefined'){
        alert('Excel ç¨‹å¼åº«å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œæˆ–æ”¹ç”¨ã€ŒåŒ¯å‡ºJSONã€å‚™ä»½ã€‚');
        return;
      }
      const y=+$('yearSel').value, m=+$('monthSel').value;
      const pad2 = n => String(n).padStart(2,'0');

      const inMonth = (dstr) => {
        if(!dstr) return false;
        const d = new Date(dstr);
        return !isNaN(d) && d.getFullYear()===y && (d.getMonth()+1)===m;
      };

      // è¨‚å–®è¡¨ï¼ˆåªå–è©²å¹´è©²æœˆæœ‰æ—¥æœŸè€…ï¼›æœªæ’æœŸé€šå¸¸ä¸åˆ—å…¥æœˆå ±è¡¨ï¼‰
      const orderHeaders = [
        'id','ä½œæ¥­äººå“¡','æ—¥æœŸ','æ™‚é–“','ç¢ºèª','å ±åƒ¹å–®','å§“å','LINE_ID','é›»è©±',
        'å®‰æ’æ™‚æ®µ(å¤šé¸)','æ—¥æœŸ/æ™‚æ®µå‚™è¨»','åœ°å€',
        'å±…ä½åœ°å‹æ…‹','å±…ä½åœ°å‹æ…‹(å…¶ä»–)','æ–¹ä¾¿è¯ç¹«æ™‚é–“(å¤šé¸)','æ–¹ä¾¿è¯ç¹«å‚™è¨»',
        'å†·æ°£æ¨“å±¤(å¤šé¸)','æ´—è¡£æ©Ÿæ¨“å±¤(å¤šé¸)','è¯ç¹«æ–¹å¼','ç‹€æ³','å®Œæˆæ™‚é–“','é‡‘é¡é–å®š',
        'åˆ†é›¢å¼å®¤å…§æ©Ÿ','åŠéš±å¼','ç›´ç«‹å¼æ´—è¡£æ©Ÿ','æ°´å¡”','è‡ªä¾†æ°´ç®¡é‡‘é¡','é˜²éœ‰å™´åŠ‘','è‡­æ°§æ®ºèŒ','è®Šå½¢é‡‘å‰›åŠ åƒ¹','é•·åº¦>182cmåŠ åƒ¹','ä¸€é«”å¼æ°´ç›¤',
        'å‚™è¨»','ç¸½é‡‘é¡','æŠ˜æ‰£é‡‘é¡','æŠ˜å¾Œç¸½é‡‘é¡','å»ºç«‹æ™‚é–“'
      ];

      const includeUndated = !!($('showUndated') && $('showUndated').checked);
    const ORDERS_SRC = (typeof orders!=='undefined' && Array.isArray(orders)?orders:[]);
    const orderRows = ORDERS_SRC
      .filter(o => o.date ? inMonth(o.date) : includeUndated)
        .sort((a,b)=> (a.date||'').localeCompare(b.date||''))
        .map(o => [
          o.id||'',
          o.staff||'',
          o.date||'',
          o.time||'',
          o.confirmed?'æ˜¯':'å¦',
          o.quotationOk?'æ˜¯':'å¦',
          o.customer||'',
          o.lineId||'',
          o.phone||'',
          (o.slots||[]).join('|')||'',
          o.slotNote||'',
          o.address||'',
          o.residenceType||'',
          o.residenceOther||'',
          (o.contactTimes||[]).join('|')||'',
          o.contactTimeNote||'',
          (o.acFloors||[]).join('|')||'',
          (o.washerFloors||[]).join('|')||'',
          o.contactMethod||'',
          o.status||'',
          o.completedAt||'',
          o.locked?'æ˜¯':'å¦',
          +o.acSplit||0,
          +o.acDuct||0,
          +o.washerTop||0,
          +o.waterTank||0,
          +o.pipesAmount||0,
          +o.antiMold||0,
          +o.ozone||0,
          +o.transformerCount||0,
          +o.longSplitCount||0,
          +o.onePieceTray||0,
          (o.note||'').replace(/\n/g,' '),
          +o.total||0,
          +o.discount||0,
          +o.netTotal||0,
          o.createdAt||''
        ]);

      // èŠ±è²»è¡¨
      const expHeaders = ['id','æ—¥æœŸ','é¡åˆ¥','èªªæ˜','é‡‘é¡','å»ºç«‹æ™‚é–“'];
      const expRows = (expenses||[])
        .filter(e => inMonth(e.date))
        .sort((a,b)=> (a.date||'').localeCompare(b.date||''))
        .map(e => [ e.id||'', e.date||'', e.category||'', (e.note||'').replace(/\n/g,' '), +e.amount||0, e.createdAt||'' ]);

      const wb = XLSX.utils.book_new();
      const wsOrders = XLSX.utils.aoa_to_sheet([orderHeaders, ...orderRows]);
      const wsExp = XLSX.utils.aoa_to_sheet([expHeaders, ...expRows]);

      wsOrders['!cols'] = orderHeaders.map((_,i)=>({wch:[10,10,10,8,6,6,12,12,12,16,16,20,12,14,16,14,14,14,10,8,10,8,8,8,8,10,8,8,8,10,10,12,20,10,10,10,16][i]||12}));
      wsExp['!cols'] = expHeaders.map((_,i)=>({wch:[10,10,10,24,10,16][i]||12}));

      XLSX.utils.book_append_sheet(wb, wsOrders, 'è¨‚å–®');
      XLSX.utils.book_append_sheet(wb, wsExp, 'èŠ±è²»');
      XLSX.writeFile(wb, `è¨‚å–®_${y}-${pad2(m)}.xlsx`);
    }

    // ---------- Search highlight helpers ----------
    let searchTokens = [];
    function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function highlightText(s){
      let out = escapeHtml(s||'');
      if(!searchTokens || searchTokens.length===0) return out;
      searchTokens.forEach(tok => {
        if(!tok) return;
        const pattern = tok.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const re = new RegExp(`(${pattern})`, 'ig');
        out = out.replace(re, '<mark>$1</mark>');
      });
      return out;
    }
    function highlightPhone(s){
      const src = escapeHtml(s||'');
      if(!searchTokens || searchTokens.length===0) return src;
      let out = src;
      searchTokens.forEach(tok => {
        const digits = tok.replace(/\D+/g,'');
        if(digits.length<3) return; // avoid over-highlighting
        // Build a pattern that allows optional separators between each digit
        const parts = digits.split('').map(ch => ch.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'));
        const pattern = parts.join('[\\s-]*');
        const re = new RegExp(`(${pattern})`, 'ig');
        out = out.replace(re, '<mark>$1</mark>');
      });
      return out;
    }

    // ---------- Inline edit for date/time in table ----------
    // ---------- Quick toggle for Confirm / Quotation and quick delete ----------
    function renderTogglePill(td, value, onText='å·²ç¢ºèª', offText='æœªç¢ºèª'){
      td.innerHTML = '';
      const span = document.createElement('span');
      span.className = 'checkpill ' + (value ? 'on' : 'off');
      span.textContent = value ? onText : offText;
      td.appendChild(span);
      return span;
    }

    function startInlineEdit(td, kind, order){
      if(td.querySelector('input')) return; // already editing
      const input = document.createElement('input');
      input.type = (kind === 'date') ? 'date' : 'time';
      input.value = (kind === 'date') ? (order.date || '') : (order.time || '');
      input.style.width = kind === 'date' ? '140px' : '110px';
      input.addEventListener('click', e => e.stopPropagation());
      td.innerHTML = '';
      td.appendChild(input);
      input.focus();
      const commit = () => {
        const val = (input.value || '').trim();
        const idx = orders.findIndex(x => x.id === order.id);
        if(idx >= 0){
          if(kind === 'date') orders[idx].date = val;
          else orders[idx].time = val;
          save(KEY, orders);
          refreshTable();
        }
      };
      const cancel = () => refreshTable();
      input.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter') commit();
        if(e.key === 'Escape') cancel();
      });
      input.addEventListener('blur', commit);
    }

    // ---------- Orders save/delete/export/import ----------
    function saveOrder(e){
      e.preventDefault();
      recalcTotals();
      const data=gatherForm(); // æ—¥æœŸå¯ç•™ç©º
      // handle completedAt & lock
      if(data.status==='å®Œæˆ'){
        data.completedAt = data.completedAt || new Date().toISOString();
        data.locked = (data.locked!==false); // default lock when completed
      } else {
        data.completedAt = undefined; data.locked = false;
      }
      const idx=orders.findIndex(x=>x.id===data.id);
      if(idx>=0){ orders[idx]={...orders[idx], ...data}; } else { orders.push(data); }
      // upsert contact
      upsertContact(data.customer, data.phone, data.address, data.lineId);
      save(KEY, orders); refreshTable(); fillForm({}); refreshContactsDatalist();
      window.scrollTo({top:0, behavior:'smooth'});
    }
    function deleteOrder(){
      const id=$('id').value; if(!id) return;
      if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ')){
        orders=orders.filter(o=>o.id!==id); save(KEY, orders); refreshTable(); fillForm({});
      }
    }
    function resetForm(){ fillForm({}); }
    function download(filename, text){ const blob=new Blob([text],{type:'application/octet-stream'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000); }
    function exportCSV(){
      const headers=['id','ä½œæ¥­äººå“¡','æ—¥æœŸ','æ™‚é–“','ç¢ºèª','å ±åƒ¹å–®','å§“å','LINE_ID','é›»è©±','å®‰æ’æ™‚æ®µ(å¤šé¸)','åœ°å€','å†·æ°£æ¨“å±¯(å¤šé¸)','æ´—è¡£æ©Ÿæ¨“å±¤(å¤šé¸)','è¯ç¹«æ–¹å¼','ç‹€æ³','å®Œæˆæ™‚é–“','é‡‘é¡é–å®š','åˆ†é›¢å¼å®¤å…§æ©Ÿ','åŠéš±å¼','ç›´ç«‹å¼æ´—è¡£æ©Ÿ','æ°´å¡”','è‡ªä¾†æ°´ç®¡é‡‘é¡','é˜²éœ‰å™´åŠ‘','è‡­æ°§æ®ºèŒ','è®Šå½¢é‡‘å‰›åŠ åƒ¹','é•·åº¦>182cmåŠ åƒ¹','ä¸€é«”å¼æ°´ç›¤','å‚™è¨»','ç¸½é‡‘é¡','æŠ˜æ‰£é‡‘é¡','æŠ˜å¾Œç¸½é‡‘é¡','å»ºç«‹æ™‚é–“'];
      const rows=orders.map(o=>[o.id,o.staff,o.date||'',o.time,o.confirmed?'æ˜¯':'å¦',o.quotationOk?'æ˜¯':'å¦',o.customer,o.lineId,o.phone,(o.slots||[]).join('|'),o.address,(o.acFloors||[]).join('|'),(o.washerFloors||[]).join('|'),o.contactMethod,o.status,o.completedAt||'',o.locked?'æ˜¯':'å¦',o.acSplit,o.acDuct,o.washerTop,o.waterTank,o.pipesAmount,o.antiMold,o.ozone,o.transformerCount,o.longSplitCount,o.onePieceTray,(o.note||'').replace(/\n/g,' '),o.total,o.discount,o.netTotal,o.createdAt||'']);
      const csv=[headers.join(','),...rows.map(r=>r.map(x=>{const s=(x??'').toString();return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;}).join(','))].join('\n');
      download(`è¨‚å–®_${$('yearSel').value}-${pad2($('monthSel').value)}.csv`, csv);
    }
    function exportJSON(){ download(`è¨‚å–®è³‡æ–™å‚™ä»½.json`, JSON.stringify({orders, staffList, contactList}, null, 2)); }
    function importJSON(){ $('filePicker').click(); }
    $('filePicker')?.addEventListener('change',(e)=>{
      const file=e.target.files[0]; if(!file) return;
      const reader=new FileReader(); reader.onload=()=>{ try{ const data=JSON.parse(reader.result);
        if(data.orders && Array.isArray(data.orders)){ orders=data.orders; save(KEY, orders); }
        if(data.staffList && Array.isArray(data.staffList)){ staffList=data.staffList; save(STAFF_KEY, staffList); initStaffSelects(); }
        if(data.contactList && Array.isArray(data.contactList)){ contactList=data.contactList; save(CONTACT_KEY, contactList); initContactSelect(); }
        refreshTable(); alert('åŒ¯å…¥å®Œæˆï¼'); }catch{ alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºã€‚'); } };
      reader.readAsText(file,'utf-8'); e.target.value='';
    });

    // add staff/contact
    function addStaff(){ const name=prompt('è¼¸å…¥æ–°ä½œæ¥­äººå“¡åç¨±ï¼š')?.trim(); if(!name) return; if(!staffList.includes(name)){ staffList.push(name); save(STAFF_KEY, staffList); initStaffSelects(); } $('staff').value=name; $('staffFilter').value=''; }
    function addContact(){ const name=prompt('è¼¸å…¥æ–°è¯ç¹«æ–¹å¼ï¼š')?.trim(); if(!name) return; if(!contactList.includes(name)){ contactList.push(name); save(CONTACT_KEY, contactList); initContactSelect(); } $('contactMethod').value=name; }

    // ---------- Expense module ----------
    function refreshExpense(){
      const y = +$('yearSel').value, m = +$('monthSel').value;
      const tbody = $('expenseTable').querySelector('tbody');
      tbody.innerHTML = '';
      const list = expenses
        .filter(e => {
          if(!e.date) return false;
          const d = new Date(e.date);
          if (isNaN(d)) return false;
          return d.getFullYear()===y && (d.getMonth()+1)===m;
        })
        .sort((a,b)=> (a.date||'').localeCompare(b.date));
      list.forEach((e, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx+1}</td>
                        <td>${escapeHtml(e.date||'')}</td>
                        <td>${escapeHtml(e.category||'')}</td>
                        <td>${escapeHtml(e.note||'')}</td>
                        <td class="right-align">${fmtCurrency(e.amount||0)}</td>`;
        tr.addEventListener('click', ()=>fillExpForm(e));
        
        // === Mobile keep list ===
        // idx: 1:æ—¥æœŸ 2:æ™‚é–“ 4:å®¢æˆ¶ 5:é›»è©± 7:åœ°å€ 9:ç¢ºèª 10:å ±åƒ¹å–® 12:æŠ˜å¾Œ 14:æ“ä½œ
        try {
          tr.children[1]?.classList.add('keep-mobile');   // æ—¥æœŸ
          tr.children[2]?.classList.add('keep-mobile');   // æ™‚é–“
          tr.children[4]?.classList.add('keep-mobile');   // å®¢æˆ¶
          tr.children[5]?.classList.add('keep-mobile');   // é›»è©±
          tr.children[7]?.classList.add('keep-mobile');   // åœ°å€
          tr.querySelector('.toggle-confirm')?.classList.add('keep-mobile'); // ç¢ºèª
          tr.querySelector('.toggle-quote')?.classList.add('keep-mobile');   // å ±åƒ¹å–®
          tr.children[12]?.classList.add('keep-mobile');  // æŠ˜å¾Œ
          tr.querySelector('.op-cell')?.classList.add('keep-mobile');        // æ“ä½œ

          // === Permanently hidden columns (provide td class hooks) ===
          tr.children[6]?.classList.add('col-slot');      // æ™‚æ®µ
          tr.children[8]?.classList.add('col-status');    // ç‹€æ³
          tr.children[11]?.classList.add('col-total');    // ç¸½é‡‘é¡
        } catch(err) { /* noop */ }

        tbody.appendChild(tr);
      });
}
    function gatherExpForm(){ return { id:$('expId').value || crypto.randomUUID(), date:$('expDate').value, category:$('expCategory').value, note:$('expNote').value.trim(), amount:+$('expAmount').value||0, createdAt:$('expId').value?undefined:new Date().toISOString() }; }
    function fillExpForm(e){ $('expId').value=e.id||''; $('expDate').value=e.date||''; $('expCategory').value=e.category||expCats[0]; $('expNote').value=e.note||''; $('expAmount').value=e.amount||0; $('expDelete').disabled=!e.id; }
    function saveExpense(ev){ ev.preventDefault(); const data=gatherExpForm(); if(!data.date){ alert('è«‹è¼¸å…¥æ—¥æœŸ'); return; } const i=expenses.findIndex(x=>x.id===data.id); if(i>=0){ expenses[i]={...expenses[i], ...data}; } else { expenses.push(data); } save(EXP_KEY, expenses); fillExpForm({}); refreshExpense(); }
    function deleteExpense(){ const id=$('expId').value; if(!id) return; if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†èŠ±è²»å—ï¼Ÿ')){ expenses=expenses.filter(x=>x.id!==id); save(EXP_KEY, expenses); fillExpForm({}); refreshExpense(); } }
    function expExportCsv(){ const headers=['id','æ—¥æœŸ','é¡åˆ¥','èªªæ˜','é‡‘é¡','å»ºç«‹æ™‚é–“']; const rows=expenses.map(e=>[e.id,e.date,e.category,(e.note||'').replace(/\n/g,' '),e.amount,e.createdAt||'']); const csv=[headers.join(','),...rows.map(r=>r.map(x=>{const s=(x??'').toString();return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;}).join(','))].join('\n'); download(`èŠ±è²»_${$('yearSel').value}-${pad2($('monthSel').value)}.csv`, csv); }
    function expExportJson(){ download(`èŠ±è²»è³‡æ–™å‚™ä»½.json`, JSON.stringify({expenses, expCats}, null, 2)); }
    function expImportJson(){ $('filePickerExp').click(); }
    $('filePickerExp')?.addEventListener('change',(e)=>{
      const file=e.target.files[0]; if(!file) return;
      const reader=new FileReader(); reader.onload=()=>{ try{ const data=JSON.parse(reader.result);
        if(data.expenses && Array.isArray(data.expenses)){ expenses=data.expenses; save(EXP_KEY, expenses); }
        if(data.expCats && Array.isArray(data.expCats)){ expCats=data.expCats; save(EXP_CAT_KEY, expCats); initExpenseCats(); }
        refreshExpense(); alert('èŠ±è²»åŒ¯å…¥å®Œæˆï¼'); }catch{ alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºã€‚'); } };
      reader.readAsText(file,'utf-8'); e.target.value='';
    });
    function addExpCat(){ const name=prompt('è¼¸å…¥æ–°èŠ±è²»é¡åˆ¥ï¼š')?.trim(); if(!name) return; if(!expCats.includes(name)){ expCats.push(name); save(EXP_CAT_KEY, expCats); initExpenseCats(); } $('expCategory').value=name; }

    // ---------- Events ----------
    function attachEvents(){
      // order form
      $('orderForm').addEventListener('submit', saveOrder);
      $('deleteBtn').addEventListener('click', deleteOrder);
      $('resetBtn').addEventListener('click', resetForm);
      $('recalc').addEventListener('click', recalcTotals);
      ['acSplit','acDuct','washerTop','waterTank','pipesAmount','antiMold','ozone','transformerCount','longSplitCount','onePieceTray','discount']
        .forEach(id => $(id).addEventListener('input', recalcTotals));
      $('newBtn').addEventListener('click', ()=>{ fillForm({}); });
$('exportJson').addEventListener('click', exportJSON);
$('importJson').addEventListener('click', importJSON);
      $('clearAll').addEventListener('click', ()=>{ if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨‚å–®è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')){ orders=[]; save(KEY, orders); refreshTable(); } });
      $('addStaffBtn').addEventListener('click', addStaff);
      $('addContactMethod').addEventListener('click', addContact);
      
      // Autofill from contacts when name/phone entered
      $('customer').addEventListener('blur', ()=>{
        const c = findContactByName($('customer').value);
        if(c){ $('phone').value = c.phone||''; if(!$('address').value) $('address').value = c.address||''; if(!$('lineId').value) $('lineId').value = c.lineId||''; }
      });
      $('phone').addEventListener('blur', ()=>{
        const c = findContactByPhone($('phone').value);
        if(c){ if(!$('customer').value) $('customer').value = c.name||''; if(!$('address').value) $('address').value = c.address||''; if(!$('lineId').value) $('lineId').value = c.lineId||''; }
      });


      // expenses
      $('expenseForm').addEventListener('submit', saveExpense);
      $('expDelete').addEventListener('click', deleteExpense);
      $('expReset').addEventListener('click', ()=>fillExpForm({}));
      $('expExportCsv').addEventListener('click', expExportCsv);
      $('expExportJson').addEventListener('click', expExportJson);
      $('expImportJson').addEventListener('click', expImportJson);
      $('expClear').addEventListener('click', ()=>{ if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰èŠ±è²»è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')){ expenses=[]; save(EXP_KEY, expenses); refreshExpense(); } });
      $('addExpCat').addEventListener('click', addExpCat);

      $('toggleLock').addEventListener('click', ()=>{
        const id=$('id').value; if(!id){ alert('è«‹å…ˆé¸æ“‡æˆ–å„²å­˜ä¸€ç­†è¨‚å–®'); return; }
        const i=orders.findIndex(o=>o.id===id); if(i<0) return;
        const wantUnlock = orders[i].locked;
        if(wantUnlock && !confirm('ç¢ºå®šè¦è§£é™¤é‡‘é¡é–å®šå—ï¼Ÿè§£é™¤å¾Œå¯ä¿®æ”¹é‡‘é¡èˆ‡æŠ˜æ‰£ã€‚')) return;
        orders[i].locked = !orders[i].locked;
        save(KEY, orders);
        setFormLock(orders[i].locked);
      });

      // è¤‡è£½ç›¸é—œ
      function copyOrderToForm(o){
        const t={...o};
        delete t.id; t.status='æ’å®š'; t.confirmed=false; t.quotationOk=false; t.completedAt=undefined; t.locked=false; t.date=''; t.time='';
        fillForm(t); recalcTotals();
        $('orderAccordion').open = true; $('orderAccordion').scrollIntoView({behavior:'smooth', block:'start'});
      }
      function copyOrderFrom(o){ copyOrderToForm(o); }
      $('copyLastBtn').addEventListener('click', ()=>{
        if(orders.length===0){ alert('ç›®å‰æ²’æœ‰å¯è¤‡è£½çš„è¨‚å–®'); return; }
        const last = [...orders].sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||''))[0];
        if(!last){ alert('æ‰¾ä¸åˆ°ä¸Šä¸€ç­†'); return; }
        copyOrderToForm(last);
      });
      $('copyFromHistoryBtn').addEventListener('click', ()=>{
        const np = normalizePhone($('phone').value);
        let cand = null;
        if(np){ cand = [...orders].filter(o=> normalizePhone(o.phone)===np).sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||''))[0]; }
        if(!cand && $('customer').value){ cand = [...orders].filter(o=> (o.customer||'')=== $('customer').value.trim()).sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||''))[0]; }
        if(!cand){ alert('æ‰¾ä¸åˆ°æ­¤å®¢æˆ¶çš„èˆŠå–®ï¼ˆè«‹å…ˆè¼¸å…¥å§“åæˆ–é›»è©±ï¼‰'); return; }
        copyOrderToForm(cand);
      });


      // Accordion behavior: auto-collapse on small screens
      function adjustAccordion(){
        const acc = $('expenseAcc');
        if(!acc) return;
        if(window.innerWidth < 900){ acc.open = false; } else { acc.open = true; }
      }
      window.addEventListener('resize', adjustAccordion);
      adjustAccordion();
    
      
    
      // residenceType toggle
      $('residenceType')?.addEventListener('change', ()=>{
        $('residenceOther').classList.toggle('hidden', $('residenceType').value!=='å…¶ä»–');
      });
      // contact time "æ™‚é–“æŒ‡å®š" toggle
      document.addEventListener('change', (e)=>{
        if(e.target && e.target.matches('input[type="checkbox"][data-name="contactTime"]')){
          const specified = Array.from(document.querySelectorAll('input[type="checkbox"][data-name="contactTime"]'))
                              .some(x=> x.checked && (x.value==='æ—¥æœŸæŒ‡å®š' || x.value==='æ™‚é–“æŒ‡å®š'));
          $('contactTimeNote').classList.toggle('hidden', !specified);
        }
      });
    
    
      // slot "æ™‚é–“æŒ‡å®š" toggle
      document.addEventListener('change', (e)=>{
        if(e.target && e.target.matches('input[type="checkbox"][data-name="slot"]')){
          const specified = Array.from(document.querySelectorAll('input[type="checkbox"][data-name="slot"]'))
                              .some(x=> x.checked && (x.value==='æ—¥æœŸæŒ‡å®š' || x.value==='æ™‚é–“æŒ‡å®š'));
          $('slotNote').classList.toggle('hidden', !specified);
        }
      });
    
    
      // auto-open orderAccordion when buttons clicked
      ;['saveBtn','resetBtn','copyLastBtn','copyFromHistoryBtn'].forEach(id=>{
        $(id)?.addEventListener('click', ()=>{ $('orderAccordion').open = true; $('orderAccordion').scrollIntoView({behavior:'smooth', block:'start'}); });
      });
    
    
      // æ–°å¢èŠ±è²»æŒ‰éˆ•ï¼šåˆ‡åˆ°èŠ±è²»å€å¡Šé ‚éƒ¨ä¸¦é‡ç½®è¡¨å–®
      $('newExpenseBtn')?.addEventListener('click', ()=>{
        if (typeof fillExpForm === 'function') fillExpForm({});
        const exp = $('expenseAcc');
        if (exp){ exp.open = true; exp.scrollIntoView({behavior:'smooth', block:'start'}); }
      });
    
    
      // æ–°å¢è¨‚å–®ï¼šå±•é–‹ä¸¦æ²å‹•åˆ°å€å¡Šé–‹é ­
      $('newBtn')?.addEventListener('click', ()=>{
        $('orderAccordion').open = true;
        $('orderAccordion').scrollIntoView({behavior:'smooth', block:'start'});
      });
        
    
      $('exportXlsx')?.addEventListener('click', exportXLSX);
    }

    // ---------- Boot ----------
    (function boot(){
      initYearMonth(); initStaffSelects(); initContactSelect(); initCheckboxes(); initExpenseCats();
      attachEvents(); refreshContactsDatalist(); fillForm({}); fillExpForm({}); refreshTable(); refreshExpense();
    })();
  </script>
<script>
/* ===== Offline .xlsx exporter (no external deps) =====
   Builds a minimal XLSX (2 sheets) using uncompressed ZIP.
   Sheets: è¨‚å–® / èŠ±è²», with inline strings (no sharedStrings).
*/
(function(){
  // --- helpers ---
  const enc = new TextEncoder();
  const toBytes = (s)=> enc.encode(s);

  // CRC32
  const CRC_TABLE = (()=>{
    let c, table = new Uint32Array(256);
    for (let n=0; n<256; n++){
      c = n;
      for (let k=0; k<8; k++){
        c = ((c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1));
      }
      table[n] = c >>> 0;
    }
    return table;
  })();
  function crc32(buf){
    let c = 0 ^ (-1);
    for (let i=0; i<buf.length; i++){
      c = (c >>> 8) ^ CRC_TABLE[(c ^ buf[i]) & 0xFF];
    }
    return (c ^ (-1)) >>> 0;
  }
  function strToXml(s){
    return (s||'').toString()
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/\r?\n/g, '&#10;');
  }
  function colName(col){ // 1->A, 2->B, ...
    let s='', n=col;
    while(n>0){ const m=(n-1)%26; s=String.fromCharCode(65+m)+s; n=Math.floor((n-1)/26); }
    return s;
  }
  function sheetXML(headers, rows){
    let r=1, out = ['<?xml version="1.0" encoding="UTF-8" standalone="yes"?>',
      '<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">',
      '<sheetData>'];
    // header row
    let cells = headers.map((h,i)=>`<c r="${colName(i+1)}${r}" t="inlineStr"><is><t>${strToXml(h)}</t></is></c>`).join('');
    out.push(`<row r="${r}">${cells}</row>`); r++;
    // data rows
    for(const row of rows){
      let cs=[];
      for(let i=0;i<row.length;i++){
        const v = row[i];
        const ref = `${colName(i+1)}${r}`;
        if(typeof v === 'number' && isFinite(v)){
          cs.push(`<c r="${ref}"><v>${v}</v></c>`);
        }else{
          cs.push(`<c r="${ref}" t="inlineStr"><is><t>${strToXml(v)}</t></is></c>`);
        }
      }
      out.push(`<row r="${r}">${cs.join('')}</row>`); r++;
    }
    out.push('</sheetData></worksheet>');
    return out.join('');
  }

  // Minimal ZIP (store only)
  function buildZip(files){ // files: [{name, data(Uint8Array)}]
    const LFH = 0x04034b50, CDH=0x02014b50, EOCD=0x06054b50;
    const arrs=[];
    let offset=0;
    const cdEntries=[];
    function pushUint32(v){ const b=new Uint8Array(4); new DataView(b.buffer).setUint32(0,v,true); arrs.push(b); offset+=4; }
    function pushUint16(v){ const b=new Uint8Array(2); new DataView(b.buffer).setUint16(0,v,true); arrs.push(b); offset+=2; }
    function pushBytes(b){ arrs.push(b); offset+=b.length; }

    for(const f of files){
      const nameBytes = toBytes(f.name);
      const data = f.data;
      const crc = crc32(data);
      const comp = 0; // store
      const modTime = 0, modDate = 0;

      // local file header
      { pushUint32(LFH);
        pushUint16(20);      // version needed
        pushUint16(0);       // flags
        pushUint16(comp);    // method
        pushUint16(modTime); // time
        pushUint16(modDate); // date
        pushUint32(crc);
        pushUint32(data.length); // compressed size (store)
        pushUint32(data.length); // uncompressed size
        pushUint16(nameBytes.length);
        pushUint16(0); // extra len
        pushBytes(nameBytes);
        pushBytes(data);
      }
      const lfhEnd = offset;

      // central directory entry
      const cdStart = offset; // not used
      const cd = [];
      function push32(v){ const b=new Uint8Array(4); new DataView(b.buffer).setUint32(0,v,true); cd.push(b); }
      function push16(v){ const b=new Uint8Array(2); new DataView(b.buffer).setUint16(0,v,true); cd.push(b); }
      push32(CDH);
      push16(20); // version made by
      push16(20); // version needed
      push16(0);  // flags
      push16(comp);
      push16(modTime); push16(modDate);
      push32(crc);
      push32(data.length); push32(data.length);
      push16(nameBytes.length); push16(0); push16(0); // name, extra, comment
      push16(0); push16(0); // disk start, int attrs
      push32(0); // ext attrs
      // relative offset of local header -> need to compute; we track by sum of previous arrays, so we store now:
      const relOffset = lfhEnd - (30 + nameBytes.length + data.length);
      push32(relOffset);
      cd.push(nameBytes);
      cdEntries.push(cd);
    }

    const cdOffset = offset;
    for(const parts of cdEntries){ for(const b of parts){ arrs.push(b); offset+=b.length; } }
    const cdSize = offset - cdOffset;

    // EOCD
    pushUint32(EOCD);
    pushUint16(0); pushUint16(0); // disk numbers
    pushUint16(files.length); pushUint16(files.length);
    pushUint32(cdSize);
    pushUint32(cdOffset);
    pushUint16(0); // comment length

    // concat
    let total = 0; for(const a of arrs) total += a.length;
    const out = new Uint8Array(total);
    let p=0; for(const a of arrs){ out.set(a,p); p+=a.length; }
    return out;
  }

  // Workbook XML pieces
  function contentTypes(){
    return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>
  <Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>
  <Override PartName="/xl/worksheets/sheet2.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>
</Types>`;
  }
  function rootRels(){
    return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>
</Relationships>`;
  }
  function workbook(){
    return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"
          xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
  <sheets>
    <sheet name="è¨‚å–®" sheetId="1" r:id="rId1"/>
    <sheet name="èŠ±è²»" sheetId="2" r:id="rId2"/>
  </sheets>
</workbook>`;
  }
  function workbookRels(){
    return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>
  <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet2.xml"/>
</Relationships>`;
  }

  // Override existing function name
  window.exportXLSX = function(){
    const y = +$('yearSel').value, m = +$('monthSel').value;
    const pad2 = n => String(n).padStart(2,'0');

    const inMonth = (dstr) => {
      if(!dstr) return false;
      const d = new Date(dstr);
      return !isNaN(d) && d.getFullYear()===y && (d.getMonth()+1)===m;
    };

    const orderHeaders = [
      'id','ä½œæ¥­äººå“¡','æ—¥æœŸ','æ™‚é–“','ç¢ºèª','å ±åƒ¹å–®','å§“å','LINE_ID','é›»è©±',
      'å®‰æ’æ™‚æ®µ(å¤šé¸)','æ—¥æœŸ/æ™‚æ®µå‚™è¨»','åœ°å€',
      'å±…ä½åœ°å‹æ…‹','å±…ä½åœ°å‹æ…‹(å…¶ä»–)','æ–¹ä¾¿è¯ç¹«æ™‚é–“(å¤šé¸)','æ–¹ä¾¿è¯ç¹«å‚™è¨»',
      'å†·æ°£æ¨“å±¤(å¤šé¸)','æ´—è¡£æ©Ÿæ¨“å±¤(å¤šé¸)','è¯ç¹«æ–¹å¼','ç‹€æ³','å®Œæˆæ™‚é–“','é‡‘é¡é–å®š',
      'åˆ†é›¢å¼å®¤å…§æ©Ÿ','åŠéš±å¼','ç›´ç«‹å¼æ´—è¡£æ©Ÿ','æ°´å¡”','è‡ªä¾†æ°´ç®¡é‡‘é¡','é˜²éœ‰å™´åŠ‘','è‡­æ°§æ®ºèŒ','è®Šå½¢é‡‘å‰›åŠ åƒ¹','é•·åº¦>182cmåŠ åƒ¹','ä¸€é«”å¼æ°´ç›¤',
      'å‚™è¨»','ç¸½é‡‘é¡','æŠ˜æ‰£é‡‘é¡','æŠ˜å¾Œç¸½é‡‘é¡','å»ºç«‹æ™‚é–“'
    ];
    const orderRows = (typeof orders!=='undefined' && Array.isArray(orders)?orders:[])
      .filter(o => inMonth(o.date))
      .sort((a,b)=> (a.date||'').localeCompare(b.date||''))
      .map(o => [
        o.id||'', o.staff||'', o.date||'', o.time||'',
        o.confirmed?'æ˜¯':'å¦', o.quotationOk?'æ˜¯':'å¦', o.customer||'',
        o.lineId||'', o.phone||'',
        (o.slots||[]).join('|')||'', o.slotNote||'', o.address||'',
        o.residenceType||'', o.residenceOther||'',
        (o.contactTimes||[]).join('|')||'', o.contactTimeNote||'',
        (o.acFloors||[]).join('|')||'', (o.washerFloors||[]).join('|')||'',
        o.contactMethod||'', o.status||'', o.completedAt||'', o.locked?'æ˜¯':'å¦',
        +o.acSplit||0, +o.acDuct||0, +o.washerTop||0, +o.waterTank||0, +o.pipesAmount||0,
        +o.antiMold||0, +o.ozone||0, +o.transformerCount||0, +o.longSplitCount||0, +o.onePieceTray||0,
        (o.note||'').replace(/\n/g,' '), +o.total||0, +o.discount||0, +o.netTotal||0, o.createdAt||''
      ]);

    const expHeaders = ['id','æ—¥æœŸ','é¡åˆ¥','èªªæ˜','é‡‘é¡','å»ºç«‹æ™‚é–“'];
    const expRows = (typeof expenses!=='undefined' && Array.isArray(expenses)?expenses:[])
      .filter(e => inMonth(e.date))
      .sort((a,b)=> (a.date||'').localeCompare(b.date||''))
      .map(e => [e.id||'', e.date||'', e.category||'', (e.note||'').replace(/\n/g,' '), +e.amount||0, e.createdAt||'']);

    // Build files
    const files = [
      {name:'[Content_Types].xml', data: toBytes(contentTypes())},
      {name:'_rels/.rels', data: toBytes(rootRels())},
      {name:'xl/workbook.xml', data: toBytes(workbook())},
      {name:'xl/_rels/workbook.xml.rels', data: toBytes(workbookRels())},
      {name:'xl/worksheets/sheet1.xml', data: toBytes(sheetXML(orderHeaders, orderRows))},
      {name:'xl/worksheets/sheet2.xml', data: toBytes(sheetXML(expHeaders, expRows))},
    ];
    const zip = buildZip(files);
    const blob = new Blob([zip], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `è¨‚å–®_${y}-${pad2(m)}.xlsx`;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1000);
  };
})();
</script>
<script>
// é‡æ–°ç¶å®šã€ŒåŒ¯å‡ºExcelã€æŒ‰éˆ•ï¼Œé¿å…æ²¿ç”¨èˆŠçš„ SheetJS äº‹ä»¶è™•ç†å™¨
window.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('exportXlsx');
  if (btn && typeof window.exportXLSX === 'function') {
    const clone = btn.cloneNode(true);           // ç§»é™¤æ—¢æœ‰æ‰€æœ‰ listener
    btn.parentNode.replaceChild(clone, btn);
    clone.addEventListener('click', () => window.exportXLSX());
  }
});
</script>
<script src="https://apis.google.com/js/api.js"></script>
<script>
let tokenClient;

function initGoogle() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: '894514639805-g3073pmjvadbasfp1g25r24rjhl9iacb.apps.googleusercontent.com',
    scope: 'https://www.googleapis.com/auth/drive.file',
    callback: async (tokenResponse) => {
      const token = tokenResponse.access_token;
      setTimeout(() => {
        Swal.fire({
          title: 'è«‹é¸æ“‡æ“ä½œ',
          input: 'radio',
          inputOptions: {
            '1': 'å‚™ä»½è‡³ Google é›²ç«¯',
            '2': 'å¾ Google é›²ç«¯é‚„åŸ'
          },
          inputValidator: (value) => {
            if (!value) return 'è«‹é¸æ“‡ä¸€é …æ“ä½œ';
          },
          confirmButtonText: 'ç¢ºå®š'
        }).then(async (result) => {
          if (result.isConfirmed) {
            const choice = result.value;
            if (choice === '1') await backupToDrive(token);
            else if (choice === '2') await restoreFromDrive(token);
          }
        });
      }, 0);
    }
  });
}

function initGoogleBackup() {
  if (!tokenClient) initGoogle();
  tokenClient.requestAccessToken();
}
function extractCityDistrict(address) {
  if (!address) return { city: '', district: '' };
  const match = address.match(/^(.*?[å¸‚ç¸£])\s*([\u4e00-\u9fa5]{1,4}[å€é„‰é®å¸‚])/);
  if (match) {
    return { city: match[1], district: match[2] };
  }
  return { city: '', district: '' };
}
function getOrderItems(o) {
  let items = [];
  if (+o.acSplit > 0) items.push(`åˆ†é›¢å¼å†·æ°£${o.acSplit}å°`);
  if (+o.acDuct > 0) items.push(`åŠéš±å¼å†·æ°£${o.acDuct}å°`);
  if (+o.washerTop > 0) items.push(`ç›´ç«‹å¼æ´—è¡£æ©Ÿ${o.washerTop}å°`);
  if (+o.waterTank > 0) items.push(`æ°´å¡”${o.waterTank}é¡†`);
  if (+o.pipesAmount > 0) items.push(`è‡ªä¾†æ°´ç®¡`);
  if (+o.antiMold > 0) items.push(`é˜²éœ‰${o.antiMold}å°`);
  if (+o.ozone > 0) items.push(`è‡­æ°§æ®ºèŒ${o.ozone}é–“`);
  if (+o.transformerCount > 0) items.push(`è®Šå½¢é‡‘å‰›${o.transformerCount}å°`);
  if (+o.longSplitCount > 0) items.push(`åˆ†é›¢å¼>182cm ${o.longSplitCount}å°`);
  if (+o.onePieceTray > 0) items.push(`ä¸€é«”å¼æ°´ç›¤${o.onePieceTray}å°`);
  return items.join('ã€');
}    
</script><script>
async function backupToDrive(token) {
  try {
    const content = JSON.stringify(localStorage, null, 2);
    const file = new Blob([content], { type: 'application/json' });

    // ä½¿ç”¨ localStorage æ§åˆ¶è¼ªæ›¿ï¼ˆ1æˆ–2ï¼‰
    let index = parseInt(localStorage.getItem('backupIndex') || '1');
    const filename = `æ¸…æ´—è¨‚å–®_å‚™ä»½_${index}.json`;

    // æŸ¥æ‰¾åŒåèˆŠæª”æ¡ˆï¼ˆå¦‚æœ‰å‰‡åˆªé™¤ï¼‰
    const searchRes = await fetch("https://www.googleapis.com/drive/v3/files?q=" + encodeURIComponent(`name='${filename}' and trashed=false`), {
      headers: new Headers({ Authorization: 'Bearer ' + token })
    });
    const searchJson = await searchRes.json();
    const existingFile = searchJson.files?.[0];
    if (existingFile) {
      await fetch("https://www.googleapis.com/drive/v3/files/" + existingFile.id, {
        method: 'DELETE',
        headers: new Headers({ Authorization: 'Bearer ' + token })
      });
    }

    // ä¸Šå‚³æ–°æª”æ¡ˆï¼ˆç›¸åŒæª”åï¼‰
    const metadata = { name: filename, mimeType: 'application/json' };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', file);

    const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
      method: 'POST',
      headers: new Headers({ Authorization: 'Bearer ' + token }),
      body: form
    });

    if (res.ok) {
      Swal.fire('âœ… å‚™ä»½æˆåŠŸ', filename, 'success');
      const next = index === 1 ? 2 : 1;
      localStorage.setItem('backupIndex', next.toString());
    } else {
      const err = await res.json();
      Swal.fire('âŒ å‚™ä»½å¤±æ•—', err.error.message, 'error');
    }
  } catch (e) {
    Swal.fire('âŒ å‚™ä»½éŒ¯èª¤', e.message, 'error');
  }
}
</script><script>
async function restoreFromDrive(token) {
  try {
    // æœå°‹å…©å€‹å‚™ä»½æª”æ¡ˆ
    const query = "name contains 'æ¸…æ´—è¨‚å–®_å‚™ä»½_' and trashed=false";
    const listRes = await fetch("https://www.googleapis.com/drive/v3/files?q=" + encodeURIComponent(query) + "&fields=files(id,name,modifiedTime)&orderBy=modifiedTime desc", {
      headers: new Headers({ Authorization: 'Bearer ' + token })
    });
    const listJson = await listRes.json();
    const files = listJson.files || [];

    if (files.length === 0) {
      return Swal.fire('âš ï¸ æ‰¾ä¸åˆ°ä»»ä½•å‚™ä»½æª”', '', 'warning');
    }

    const inputOptions = {};
    files.slice(0, 2).forEach(file => {
      const time = new Date(file.modifiedTime).toLocaleString();
      inputOptions[file.id] = `${file.name}ï¼ˆ${time}ï¼‰`;
    });

    const { value: fileId } = await Swal.fire({
      title: 'é¸æ“‡è¦é‚„åŸçš„å‚™ä»½æª”',
      input: 'radio',
      inputOptions,
      inputValidator: (value) => !value && 'è«‹é¸æ“‡ä¸€å€‹æª”æ¡ˆ',
      confirmButtonText: 'é‚„åŸ'
    });

    if (!fileId) return;

    const downloadRes = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
      headers: new Headers({ Authorization: 'Bearer ' + token })
    });
    const data = await downloadRes.json();

    localStorage.clear();
    for (const [key, value] of Object.entries(data)) {
      localStorage.setItem(key, value);
    }

    Swal.fire('âœ… é‚„åŸæˆåŠŸ', '', 'success').then(() => location.reload());
  } catch (e) {
    Swal.fire('âŒ é‚„åŸéŒ¯èª¤', e.message, 'error');
  }
}
</script><div>
<!-- âœ… è¼‰å…¥ Google OAuth SDK -->
<script async="" defer="" src="https://accounts.google.com/gsi/client"></script>
<script>
const CLIENT_ID = '894514639805-g3073pmjvadbasfp1g25r24rjhl9iacb.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/calendar.events';
let gToken = null;

function handleUploadWithAuth(orderData) {
  if (!orderData.date || !orderData.time) {
    alert('è«‹å…ˆå¡«å¯«æ­¤è¨‚å–®çš„æ—¥æœŸèˆ‡æ™‚é–“');
    return;
  }
  if (gToken) {
    uploadEventToCalendar(orderData);
  } else {
    const tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: (tokenResponse) => {
        gToken = tokenResponse.access_token;
        uploadEventToCalendar(orderData);
      }
    });
    tokenClient.requestAccessToken();
  }
}

async function uploadEventToCalendar(o) {
  const start = new Date(`${o.date}T${o.time}:00`);
  const duration = +o.durationMinutes || 120;
  const end = new Date(start.getTime() + duration * 60 * 1000);

  // æ–°å¢ï¼šè‡ªå‹•çµ„åˆç¸£å¸‚å€ï¼‹å§“åï¼‹æ¸…æ´—é …ç›®
  const { city, district } = extractCityDistrict(o.address || '');
  const orderItems = getOrderItems(o);
  const summary = `${city}${district} ${o.customer || ''} ${orderItems}`;

  const event = {
    summary,
    location: o.address || '',
    description: [
      `å§“åï¼š${o.customer || ''}`,
      `é›»è©±ï¼š${o.phone || ''}`,
      (o.acFloors && o.acFloors.length > 0) ? `å†·æ°£ä½æ–¼æ¨“å±¤ï¼š${o.acFloors.join('ã€')}` : '',
      (o.washerFloors && o.washerFloors.length > 0) ? `æ´—è¡£æ©Ÿä½æ–¼æ¨“å±¤ï¼š${o.washerFloors.join('ã€')}` : ''
    ].filter(Boolean).join('\n'),
    start: { dateTime: start.toISOString() },
    end: { dateTime: end.toISOString() }
  };

  const res = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ' + gToken,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(event)
  });

  if (res.ok) {
    alert(`\u2705 å·²æˆåŠŸåŠ å…¥ Google æ—¥æ›†ï¼`);
  } else {
    const err = await res.json();
    alert(`\u274C ä¸Šå‚³å¤±æ•—ï¼š${err.error?.message || 'æœªçŸ¥éŒ¯èª¤'}`);
  }
}
</script>
<!-- âœ… åŠ åœ¨ refreshTable çš„æ¯ç­†è¨‚å–®æ“ä½œæ¬„ä½ä¸­ -->
<script>
// ğŸ“… åŠ å…¥ Google æ—¥æ›†æŒ‰éˆ•
const calBtn = document.createElement('button');
calBtn.className = 'icon-btn';
calBtn.textContent = 'ğŸ“…';
calBtn.title = 'åŠ å…¥ Google æ—¥æ›†';
calBtn.addEventListener('click', (ev) => {
  ev.stopPropagation();
  handleUploadWithAuth(o);
});
op.appendChild(calBtn);
</script>
<!-- âœ… è¡¨å–®ä¸­æ–°å¢ï¼šå·¥ä½œæ™‚é•·æ¬„ä½ -->
<!-- âœ… gatherForm() ä¸­è£œä¸Š -->
</div></body>
</html>
<script>
// å¼·åˆ¶æ‰‹é¢¨ç´é è¨­æ”¶åˆï¼ˆè§£æ±ºéƒ¨åˆ†ç€è¦½å™¨ <details> é è¨­å±•é–‹å•é¡Œï¼‰
window.addEventListener('DOMContentLoaded', () => {
  const order = document.getElementById('orderAccordion');
  const exp = document.getElementById('expenseAcc');
  if (order) order.open = false;
  if (exp) exp.open = false;
});
</script>
<!-- åŠ å…¥ Google API SDK -->
<script async="" defer="" src="https://accounts.google.com/gsi/client"></script>
